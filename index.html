<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="D&D 5e Character Sheet PWA">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>5e Character Sheet</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fdf6e3">
    <style>
        :root { --bg-color: #fdf6e3; --text-color: #2b2b2b; --border-color: #5c4b3f; --faint-line: #dcd6c7; }
        * { box-sizing: border-box; }
        body { font-family: 'Georgia', 'Times New Roman', serif; background-color: #222; margin: 0; padding: 20px; color: var(--text-color); display: flex; justify-content: center; }
        #app-controls { position: absolute; top: 0; left: 0; width: 100%; background: #333; color: white; padding: 5px 10px; display: flex; flex-wrap: nowrap; gap: 5px; z-index: 1000; font-family: sans-serif; align-items: center; transition: max-height 0.3s ease; overflow: hidden; max-height: 50px; }
        #app-controls .app-btn { display: inline-block; transition: all 0.3s ease; }
        #app-controls.expanded { flex-wrap: wrap; max-height: 500px; }        #app-controls.expanded { max-height: 500px; }
        #app-controls button { padding: 3px 6px; font-size: 0.85rem; white-space: nowrap; }
        #app-toggle-hamburger { display: none; }
        button { padding: 5px 10px; cursor: pointer; background: #555; color: white; border: 1px solid #777; }
        @media print { #app-controls { display: none !important; } body { background: white; padding: 0; display: block; } .sheet-container { width: 100%; max-width: 100%; box-shadow: none; padding: 0; margin: 0; } textarea { border: 1px solid #ccc; } }
        .sheet-container { background-color: var(--bg-color); width: 100%; max-width: 950px; padding: 40px; box-shadow: 0 0 15px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 20px; margin-top: 40px; }
        input[type="text"], input[type="number"], textarea { background: transparent; border: none; border-bottom: 1px solid var(--border-color); width: 100%; font-family: inherit; font-size: 1rem; color: var(--text-color); }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
        @media (hover: hover) { input[type="number"]:hover::-webkit-outer-spin-button, input[type="number"]:hover::-webkit-inner-spin-button { -webkit-appearance: auto; } input[type="number"]:hover { -moz-appearance: number-input; } }
        textarea { resize: vertical; border: 1px solid var(--faint-line); padding: 5px; }
        .label-sm { font-size: 0.7rem; text-transform: uppercase; color: #666; font-family: sans-serif; display: block; margin-top: 2px;}
        .main-header { display: grid; grid-template-columns: 2.5fr 1fr 1fr 1fr; gap: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 20px; }
        .header-section { display: flex; flex-direction: column; justify-content: flex-end; }
        .main-grid { display: grid; grid-template-columns: 1fr 2.6fr; gap: 25px; }
        .stats-col { display: flex; flex-direction: column; gap: 15px; }
        .ability-box { border: 2px solid var(--border-color); border-radius: 10px; padding: 10px 5px; text-align: center; background: rgba(255,255,255,0.3); }
        .ability-score { font-size: 1.5rem; font-weight: bold; width: 50px; margin: 0 auto; display: block; text-align: center; border: 1px solid #ccc; border-radius: 5px; }
        .ability-mod { font-size: 2rem; font-weight: bold; border: none; text-align: center;}
        .skills-list { font-size: 0.85rem; text-align: left; margin-top: 15px; padding-left: 5px; }
        .skill-row { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; border-bottom: 1px solid #eee; }
        .prof-bubble { width: 12px; height: 12px; border: 1px solid black; border-radius: 50%; appearance: none; cursor: pointer; flex-shrink: 0; }
        .prof-bubble:checked { background: black; }
        .save-val-input { width: 25px !important; text-align: center; font-size: 0.8rem; margin-right: 5px; border-bottom: 1px solid #999 !important; }
        .combat-row-1 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .combat-row-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 20px; }
        .shield-box { border: 2px double var(--border-color); padding: 5px; text-align: center; border-radius: 5px 5px 50% 50%; display: flex; flex-direction: column; justify-content: center; }
        .rect-box { border: 2px double var(--border-color); padding: 5px; border-radius: 5px; display: flex; flex-direction: column; }
        .box-title { font-family: sans-serif; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; text-align: center; margin-bottom: 5px;}
        .death-save-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; margin-top: 5px; }
        .ds-bubbles { display: flex; gap: 5px; }
        .physical-traits-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 5px; }
        .trait-item { text-align: center; }
        .weapons-table, .spells-list-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .weapons-table th, .spells-list-table th { text-align: left; border-bottom: 2px solid var(--border-color); font-size: 0.8rem; }
        .weapons-table td, .spells-list-table td { border-bottom: 1px solid var(--faint-line); padding: 5px 0; }
        .bottom-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .tall-box { height: 200px; display: flex; flex-direction: column;}
        .panel { border: 2px solid var(--border-color); border-radius: 5px; padding: 10px; }
        .prof-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem; margin-bottom: 10px; }
        .prof-check-row { display: flex; gap: 10px; align-items: center; }
        .spell-grid-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-top: 20px; border-top: 3px double var(--border-color); padding-top: 20px; }
        .spell-header { display: grid; grid-template-columns: 1.5fr 3.5fr; gap: 15px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .spell-stats-box { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .spell-stat-item { border: 1px solid var(--border-color); border-radius: 5px; padding: 5px; text-align: center; }
        .spell-slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px 5px; font-size: 0.8rem; white-space: nowrap; }
        .diamond-check { appearance: none; width: 12px; height: 12px; border: 1px solid black; transform: rotate(45deg); margin: 2px 3px; cursor: pointer; display: inline-block; vertical-align: middle; }
        .diamond-check:checked { background: black; }
        .bio-col { display: flex; flex-direction: column; gap: 15px; height: 100%; }
        .coins-container { border: 2px solid var(--border-color); padding: 5px; border-radius: 10px; display: flex; flex-direction: column; }
        .coins { display: flex; gap: 5px; justify-content: space-around; }
        .coin-slot input { width: 40px; text-align: center; }

        @media screen and (max-width: 768px) {
            body { display: block; padding: 0; }
            #app-controls {
                position: absolute;
                flex-wrap: nowrap;
                overflow: hidden;
                max-height: 45px;
                transition: max-height 0.3s ease;
            }
            #app-controls.expanded {
                max-height: 500px;
                flex-wrap: wrap;
            }
            /* Hide all app-btns except status and hamburger toggle */
            #app-controls .app-btn { display: none; }
            #app-controls.expanded .app-btn { display: inline-block; }
            #status, #auth-btn, #app-toggle-hamburger { display: inline-block; }
            #app-controls button { padding: 3px 5px; font-size: 0.75rem; }
            .sheet-container { margin-top: 0; padding: 10px; padding-top: 100px; border-radius: 0; box-shadow: none; }
            .main-grid, .spell-grid-layout, .main-header, .combat-row-1, .combat-row-2, .spell-header, .bottom-sections, .prof-grid { display: flex; flex-direction: column; }
            #status { margin-left: 0; width: 100%; }
        }

        /* TOOLTIP CSS */
        #ai-tooltip {
            position: fixed; background: rgba(20, 20, 20, 0.95); color: #dcd6c7; padding: 10px 15px; border-radius: 4px;
            border: 1px solid #800; font-family: 'Courier New', monospace; font-size: 0.85rem; max-width: 250px; z-index: 9999;
            pointer-events: none; opacity: 0; transition: opacity 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.5); line-height: 1.4;
        }
        #ai-tooltip strong { color: #ff5555; display: block; margin-bottom: 4px; text-transform: uppercase; font-size: 0.75rem; border-bottom: 1px solid #444; padding-bottom: 2px; }
        body.tips-enabled [data-tip] { cursor: help; border-bottom: 1px dotted #888; }
        body.tips-enabled [data-tip]:hover, body.tips-enabled [data-tip]:focus { color: #800; border-bottom: 1px solid #800; outline: none; }
        [data-tip] { outline: none; } /* Prevent default focus outlines if tips are off */
    </style>
</head>
<body>

    <div id="ai-tooltip"></div>

    <div id="app-controls">
        <span><b>D&D 5e</b></span>
        <button id="auth-btn">Login with Google</button>
        <button class="app-btn" id="toggle-tips" onclick="toggleTips()" style="background: #222;">Tips: OFF</button>

        <select class="app-btn" id="charSelect" onchange="loadMyCharacter()" style="max-width: 150px; display:none;">
            <option value="">My Characters...</option>
        </select>

        <button class="app-btn" onclick="saveVersion(true)">Save Snapshot</button>
        <select class="app-btn" id="versionSelect" onchange="loadSelectedVersion()">
            <option value="">Load Version...</option>
        </select>
        <button class="app-btn" onclick="resetSheet()" style="background: #800;">New</button>
        <button class="app-btn" onclick="window.print()" style="background: #005f80;">Print</button>
        <button class="app-btn" onclick="shareSheet()" style="background: #28a745;">Share URL</button>

        <span id="status" style="font-size: 0.8rem; color: #aaa; margin-left: auto;">Offline Mode</span>

        <button id="app-toggle-hamburger">â˜°</button>
    </div>

    <div class="sheet-container">
        <div class="main-header">
            <div class="header-section">
                <input type="text" id="charName" placeholder="Character Name" style="font-size: 1.5rem; font-weight: bold;">
                <span class="label-sm" data-tip="Character Name" tabindex="0">Character Name</span>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <div style="flex: 1;">
                        <input type="text" id="species" placeholder="Species">
                        <span class="label-sm" data-tip="Species" tabindex="0">Species</span>
                    </div>
                    <div style="flex: 1;">
                        <input type="text" id="background" placeholder="Background">
                        <span class="label-sm" data-tip="Background" tabindex="0">Background</span>
                    </div>
                </div>
            </div>
            <div class="header-section">
                <input type="text" id="class">
                <span class="label-sm" data-tip="Class" tabindex="0">Class</span>
                <input type="text" id="subclass">
                <span class="label-sm" data-tip="Subclass" tabindex="0">Subclass</span>
            </div>
            <div class="header-section">
                <input type="text" id="level">
                <span class="label-sm" data-tip="Level" tabindex="0">Level</span>
                <input type="text" id="xp">
                <span class="label-sm" data-tip="XP" tabindex="0">XP</span>
            </div>
            <div class="header-section">
                <div class="shield-box">
                    <span class="box-title" data-tip="AC" tabindex="0">Armor Class</span>
                    <input type="number" id="ac" style="font-size: 1.5rem; text-align: center; border: none;">
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="stats-col">
                <div class="ability-box">
                    <span class="box-title" data-tip="Proficiency" tabindex="0">Prof. Bonus</span>
                    <input type="text" id="prof-bonus" style="font-size: 1.5rem; text-align: center; border:none;">
                </div>
                <div id="ability-scores-container"></div>
            </div>

            <div class="main-col">
                <div class="combat-row-1">
                    <div class="shield-box"><span class="box-title" data-tip="Initiative" tabindex="0">Initiative</span><input type="text" id="initiative" placeholder="d20 + dex mod" style="text-align: center; font-size: 1rem;"></div>
                    <div class="shield-box"><span class="box-title" data-tip="Speed" tabindex="0">Speed</span><input type="text" id="speed" style="text-align: center; font-size: 1rem;"></div>
                    <div class="shield-box"><span class="box-title" data-tip="Size" tabindex="0">Size</span><input type="text" id="size" style="text-align: center; font-size: 1rem;"></div>
                    <div class="shield-box"><span class="box-title" data-tip="Passive Perception" tabindex="0">Passive Perc.</span><input type="text" id="pass-perc" style="text-align: center; font-size: 1rem;"></div>
                </div>

                <div class="combat-row-2">
                    <div class="rect-box">
                        <span class="box-title" data-tip="Hit Points" tabindex="0">Hit Points</span>
                        <div style="display: flex; gap: 10px; height: 100%;">
                            <div style="flex:1; text-align: center;"><input type="number" id="hp-max" placeholder="Max" style="text-align:center;"><span class="label-sm">Max</span></div>
                            <div style="flex:1; text-align: center;"><input type="number" id="hp-curr" placeholder="Current" style="text-align:center; font-size: 1.2rem; font-weight: bold;"><span class="label-sm">Current</span></div>
                            <div style="flex:1; text-align: center;"><input type="number" id="hp-temp" placeholder="Temp" style="text-align:center;"><span class="label-sm">Temp</span></div>
                        </div>
                    </div>
                    <div class="rect-box">
                        <span class="box-title" data-tip="Death Saves" tabindex="0">Death Saves</span>
                        <div class="death-save-row"><span data-tip="Successes" tabindex="0">Successes</span><div class="ds-bubbles"><input type="checkbox" class="prof-bubble" id="ds-s-1"><input type="checkbox" class="prof-bubble" id="ds-s-2"><input type="checkbox" class="prof-bubble" id="ds-s-3"></div></div>
                        <div class="death-save-row"><span data-tip="Failures" tabindex="0">Failures</span><div class="ds-bubbles"><input type="checkbox" class="prof-bubble" id="ds-f-1"><input type="checkbox" class="prof-bubble" id="ds-f-2"><input type="checkbox" class="prof-bubble" id="ds-f-3"></div></div>
                    </div>
                </div>

                <div class="panel" style="margin-bottom: 15px;">
                    <span class="box-title" tabindex="0">Physical Characteristics</span>
                    <div class="physical-traits-grid">
                        <div class="trait-item"><input type="text" id="age" placeholder="25"><span class="label-sm">Age</span></div>
                        <div class="trait-item"><input type="text" id="height" placeholder="5'10"><span class="label-sm">Height</span></div>
                        <div class="trait-item"><input type="text" id="weight" placeholder="160 lbs"><span class="label-sm">Weight</span></div>
                    </div>
                    <div class="physical-traits-grid">
                        <div class="trait-item"><input type="text" id="eyes" placeholder="Blue"><span class="label-sm">Eyes</span></div>
                        <div class="trait-item"><input type="text" id="skin" placeholder="Fair"><span class="label-sm">Skin</span></div>
                        <div class="trait-item"><input type="text" id="hair" placeholder="Brown"><span class="label-sm">Hair</span></div>
                    </div>
                </div>

                <div class="panel">
                    <span class="box-title" data-tip="Weapons" tabindex="0">Weapons & Damage Cantrips</span>
                    <table class="weapons-table">
                        <thead><tr><th>Name</th><th data-tip="Atk/DC" tabindex="0">Atk/DC</th><th data-tip="Damage" tabindex="0">Damage</th><th>Notes</th></tr></thead>
                        <tbody id="weapons-body"></tbody>
                    </table>
                    <button onclick="addWeaponRow()" style="width: 100%;">+</button>
                </div>

                <div class="panel" style="margin-top: 10px;">
                    <span class="box-title" data-tip="Proficiencies" tabindex="0">Proficiencies & Training</span>
                    <div style="margin-bottom: 5px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                        <span class="label-sm" style="display:inline; margin-right: 10px;">Armor:</span>
                        <label><input type="checkbox" id="prof-armor-light"> Light</label> &nbsp;
                        <label><input type="checkbox" id="prof-armor-medium"> Medium</label> &nbsp;
                        <label><input type="checkbox" id="prof-armor-heavy"> Heavy</label> &nbsp; | &nbsp;
                        <label><input type="checkbox" id="prof-shields"> Shields</label>
                    </div>
                    <div class="prof-grid">
                        <div><span class="label-sm">Weapons</span><textarea id="prof-weapons-text" style="height: 240px;"></textarea></div>
                        <div><span class="label-sm">Tools</span><textarea id="prof-tools-text" style="height: 240px;"></textarea></div>
                    </div>
                </div>

                <div class="panel" style="margin-top: 10px;">
                    <span class="box-title" data-tip="Features" tabindex="0">Class Features</span>
                    <textarea id="class-features" style="height: 120px; border:none;"></textarea>
                </div>

                <div class="panel" style="margin-top: 10px;">
                    <span class="box-title" data-tip="Background Features" tabindex="0">Background Features</span>
                    <textarea id="background-features" style="height: 100px; border:none;"></textarea>
                </div>

                <div class="bottom-sections">
                    <div class="panel tall-box"><span class="box-title" data-tip="Species Traits" tabindex="0">Species Traits</span><textarea id="species-traits" style="height: 100%; border:none;"></textarea></div>
                    <div class="panel tall-box"><span class="box-title" data-tip="Feats" tabindex="0">Feats</span><textarea id="feats" style="height: 100%; border:none;"></textarea></div>
                </div>

            </div>
        </div>

        <div class="spell-grid-layout">
            <div>
                <div class="spell-header">
                    <div class="panel">
                        <span class="box-title" style="margin-bottom: 10px; display:block;" data-tip="Spellcasting" tabindex="0">Spellcasting</span>
                        <div class="spell-stats-box">
                            <div class="spell-stat-item">
                                <span class="label-sm" data-tip="Spell Ability" tabindex="0">Ability</span>
                                <select id="spell-ability" style="width: 100%; background: transparent; border: none; border-bottom: 1px solid var(--border-color); text-align: center; font-family: inherit;">
                                    <option value="">None</option>
                                    <option value="strength">Str</option>
                                    <option value="dexterity">Dex</option>
                                    <option value="constitution">Con</option>
                                    <option value="intelligence">Int</option>
                                    <option value="wisdom">Wis</option>
                                    <option value="charisma">Cha</option>
                                </select>
                            </div>
                            <div class="spell-stat-item"><span class="label-sm" data-tip="Spell Mod" tabindex="0">Modifier</span><input type="text" id="spell-mod" style="text-align:center;"></div>
                            <div class="spell-stat-item"><span class="label-sm" data-tip="Save DC" tabindex="0">Save DC</span><input type="text" id="spell-save-dc" style="text-align:center;"></div>
                            <div class="spell-stat-item"><span class="label-sm" data-tip="Spell Atk" tabindex="0">Atk Bonus</span><input type="text" id="spell-atk" style="text-align:center;"></div>
                        </div>
                    </div>
                    <div class="panel">
                        <span class="box-title" data-tip="Spell Slots" tabindex="0">Spell Slots</span>
                        <div class="spell-slots-grid" id="spell-slots-container"></div>
                    </div>
                </div>

                <div class="panel">
                    <span class="box-title" data-tip="Cantrips" tabindex="0">Cantrips & Prepared Spells</span>
                    <table class="spells-list-table">
                        <thead>
                            <tr>
                                <th width="30">Lvl</th>
                                <th>Name</th>
                                <th width="120" style="text-align: center;">
                                    <span title="Verbal" data-tip="Verbal" tabindex="0">V</span> /
                                    <span title="Somatic" data-tip="Somatic" tabindex="0">S</span> /
                                    <span title="Concentration" data-tip="Concentration" tabindex="0">C</span> /
                                    <span title="Ritual" data-tip="Ritual" tabindex="0">R</span> /
                                    <span title="Material" data-tip="Material" tabindex="0">M</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="spells-body"></tbody>
                    </table>
                    <button onclick="addSpellRow()" style="width: 100%;">+</button>
                </div>
            </div>

            <div class="bio-col">
                <div class="panel"><span class="box-title" data-tip="Appearance" tabindex="0">Appearance</span><textarea id="appearance" style="height: 120px; border:none;"></textarea></div>
                <div class="panel" style="height: 250px; display: flex; flex-direction: column;">
                    <span class="box-title" data-tip="Backstory" tabindex="0">Backstory & Personality</span>
                    <textarea id="backstory" style="flex-grow: 1; border:none;"></textarea>
                    <div style="margin-top: 5px; border-top: 1px solid #ccc; padding-top: 5px;">
                        <span class="label-sm" style="display:inline;" data-tip="Alignment" tabindex="0">Alignment:</span>
                        <input type="text" id="alignment" style="width: 70%; display:inline-block;">
                    </div>
                </div>
                <div class="panel"><span class="box-title" data-tip="Languages" tabindex="0">Languages</span><textarea id="languages" style="height: 50px; border:none;"></textarea></div>
                <div class="panel" style="flex-grow: 1;"><span class="box-title" data-tip="Equipment" tabindex="0">Equipment</span><textarea id="equipment" style="height: 300px; border:none;"></textarea></div>
                <div class="coins-container">
                    <span class="box-title" data-tip="Coins" tabindex="0">COINS</span>
                    <div class="coins">
                        <div class="coin-slot"><span class="label-sm" data-tip="CP" tabindex="0">CP</span><input type="number" id="cp"></div>
                        <div class="coin-slot"><span class="label-sm" data-tip="SP" tabindex="0">SP</span><input type="number" id="sp"></div>
                        <div class="coin-slot"><span class="label-sm" data-tip="EP" tabindex="0">EP</span><input type="number" id="ep"></div>
                        <div class="coin-slot"><span class="label-sm" data-tip="GP" tabindex="0">GP</span><input type="number" id="gp"></div>
                        <div class="coin-slot"><span class="label-sm" data-tip="PP" tabindex="0">PP</span><input type="number" id="pp"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, query, where, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIG ---
        let tipsEnabled = false;
        let AI_COMMENTS = {};

        const firebaseConfig = {
          apiKey: "AIzaSyAMfAkyUevv3BDKSO3yBjRra3jZ_uV5OlA",
          authDomain: "dnd-character-sheet-5e.firebaseapp.com",
          projectId: "dnd-character-sheet-5e",
          storageBucket: "dnd-character-sheet-5e.firebasestorage.app",
          messagingSenderId: "554732035132",
          appId: "1:554732035132:web:ed89be7af2ceea147a7739"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // --- STATE ---
        let currentUser = null;
        let currentCharacterId = localStorage.getItem('dnd_char_id') || generateUUID();
        let isCloudOwner = true;
        let isLoading = false;

        // Conflict/Sync State
        let lastLoadedRemoteTimestamp = 0;
        let lastLocalChangeTimestamp = 0;
        let lastAutoSnapshotTime = 0;

        // UI Helpers
        const appControls = document.getElementById('app-controls');
        const toggleHandle = document.getElementById('app-toggle-hamburger');
        toggleHandle.addEventListener('click', (e) => { e.stopPropagation(); appControls.classList.toggle('expanded'); });
        function updateMobileToggle() { toggleHandle.style.display = (window.innerWidth <= 768) ? 'inline-block' : 'none'; }
        updateMobileToggle(); window.addEventListener('resize', updateMobileToggle);

        localStorage.setItem('dnd_char_id', currentCharacterId);

        // --- AUTH & INITIALIZATION ---
        window.login = async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert("Login failed: " + e.message); } };
        window.logout = () => { signOut(auth); window.location.reload(); };

        onAuthStateChanged(auth, async (user) => {
            const authBtn = document.getElementById('auth-btn');
            const statusEl = document.getElementById('status');
            const charSelect = document.getElementById('charSelect');

            if (user) {
                currentUser = user;
                authBtn.innerText = `Logout (${user.displayName.split(' ')[0]})`;
                authBtn.onclick = window.logout;
                statusEl.innerText = "Online";
                charSelect.style.display = "inline-block";

                await updateMyCharactersList(); // Load list of owned chars
                await setupRealtimeListener();  // Sync current char
                updateSnapshotSelect();         // Load history
            } else {
                currentUser = null;
                authBtn.innerText = "Login with Google";
                authBtn.onclick = window.login;
                statusEl.innerText = "Offline Mode";
                charSelect.style.display = "none";
            }
        });

        // --- MAIN VERSIONED STORAGE LOGIC IMPLEMENTATION ---

        // 1. List Owned Characters
        async function updateMyCharactersList() {
            if(!currentUser) return;
            const select = document.getElementById('charSelect');
            try {
                // Query: Characters where ownerId == uid
                const q = query(collection(db, "characters"), where("ownerId", "==", currentUser.uid));
                const snap = await getDocs(q);

                select.innerHTML = '<option value="">My Characters...</option>';
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const name = d.sheetData?.charName || "Unnamed";
                    const opt = document.createElement('option');
                    opt.value = docSnap.id;
                    opt.text = name;
                    select.appendChild(opt);
                });
                // Add option to start new
                const newOpt = document.createElement('option');
                newOpt.value = "NEW";
                newOpt.text = "+ Create New Character";
                select.appendChild(newOpt);

            } catch(e) { console.error("Error listing characters", e); }
        }

        window.loadMyCharacter = async function() {
            const select = document.getElementById('charSelect');
            const val = select.value;
            if(!val) return;

            if(val === "NEW") {
                window.resetSheet(); // Generates new ID internally
                return;
            }

            // Load the Head Document of the selected character
            currentCharacterId = val;
            localStorage.setItem('dnd_char_id', currentCharacterId);

            // Reload page to reset state cleanly or just call load logic
            // For stability in this migration, let's reload with query param
            window.location.href = `${window.location.pathname}?charId=${val}`;
        }

        // 2. Realtime Sync (Head Document)
        function setupRealtimeListener() {
            if (!currentUser || !currentCharacterId) return;

            onSnapshot(doc(db, "characters", currentCharacterId), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();

                    // Determine ownership
                    isCloudOwner = (currentUser.uid === data.ownerId);
                    document.getElementById('status').innerText = isCloudOwner ? "Online (Owner)" : "Online (Read Only)";

                    // Check Logic 6: Conflict Detection
                    const cloudTime = new Date(data.lastUpdated || 0).getTime();

                    // If cloud is newer than what we last loaded...
                    if (cloudTime > lastLoadedRemoteTimestamp) {
                        // ...and we have made local edits since the last load...
                        if (lastLocalChangeTimestamp > lastLoadedRemoteTimestamp) {
                            // CONFLICT!
                            if (confirm("New version available! Local edits detected. Overwrite local changes?")) {
                                loadHeadData(data, cloudTime);
                            } else {
                                // User chose to keep local. We don't update lastLoadedRemoteTimestamp,
                                // so this check will happen again next sync unless we save.
                            }
                        } else {
                            // NO CONFLICT (Silent Load)
                            loadHeadData(data, cloudTime);
                        }
                    }
                } else {
                    // Document doesn't exist yet (new character)
                    isCloudOwner = true;
                    document.getElementById('status').innerText = "Online (New)";
                }
            });

            // Also listen for snapshots to update dropdown
            const snapsCol = collection(db, "characters", currentCharacterId, "snapshots");
            const snapsQ = query(snapsCol, orderBy("createdAt", "desc"), limit(20));
            onSnapshot(snapsQ, (qSnap) => {
                const select = document.getElementById('versionSelect');
                select.innerHTML = '<option value="">Load Version...</option>';
                qSnap.forEach(doc => {
                    const d = doc.data();
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.text = `${d.name || 'Auto'} (${new Date(d.createdAt).toLocaleTimeString()})`;
                    select.appendChild(opt);
                });
            });
        }

        function loadHeadData(data, timestamp) {
            isLoading = true;
            populateData(data.sheetData);
            lastLoadedRemoteTimestamp = timestamp;
            isLoading = false;
        }

        // 3. Saving & Auto-Save
        window.saveVersion = async function(isManualSnapshot = false) {
            if (!currentUser) return alert("Login required.");
            if (!isCloudOwner) return alert("You can only save characters you own.");

            const data = collectData();
            const now = new Date();
            const nowIso = now.toISOString();
            const charRef = doc(db, "characters", currentCharacterId);

            try {
                // A. Update HEAD document (Always)
                // This keeps the "Current State" for sharing and listing
                await setDoc(charRef, {
                    ownerId: currentUser.uid, // Claim ownership
                    lastUpdated: nowIso,
                    sheetData: data
                }, { merge: true }); // Merge to avoid overwriting creation fields if any

                lastLoadedRemoteTimestamp = now.getTime(); // Update our sync baseline

                // B. Create Snapshot (Periodically or Manually)
                // Logic: Save snapshot if manual button OR if > 5 mins since last auto-snap
                if (isManualSnapshot || (now.getTime() - lastAutoSnapshotTime > 5 * 60 * 1000)) {

                    let name = "Auto-Save";
                    if (isManualSnapshot) {
                        name = prompt("Snapshot Name:", `Version ${now.toLocaleTimeString()}`);
                        if (!name) return; // Cancelled
                    }

                    await addDoc(collection(db, "characters", currentCharacterId, "snapshots"), {
                        name: name,
                        createdAt: nowIso,
                        sheetData: data,
                        createdBy: currentUser.uid
                    });

                    lastAutoSnapshotTime = now.getTime();
                    if(isManualSnapshot) alert("Snapshot Saved!");
                }

                // Refresh list if this was a new character creation
                updateMyCharactersList();

            } catch (e) {
                console.error("Save error:", e);
                alert("Error saving: " + e.message);
            }
        };

        // Load a specific historical snapshot
        window.loadSelectedVersion = async function() {
            const select = document.getElementById('versionSelect');
            const snapId = select.value;
            if(!snapId) return;

            if(!confirm("Load this historical version? Unsaved changes will be lost.")) return;

            isLoading = true;
            try {
                const snapDoc = await getDoc(doc(db, "characters", currentCharacterId, "snapshots", snapId));
                if(snapDoc.exists()) {
                    const d = snapDoc.data();
                    populateData(d.sheetData);
                    // We treat loading a snapshot like a local edit effectively,
                    // so the next save becomes the new "Current"
                    lastLocalChangeTimestamp = Date.now();
                    alert(`Loaded: ${d.name}`);
                }
            } catch(e) { console.error(e); }
            finally { isLoading = false; }
        }

        // --- EXISTING UTILS ---

        async function loadSharedCharacter(sharedId) {
            isLoading = true;
            document.getElementById('status').innerText = "Loading Shared...";
            try {
                const docRef = doc(db, "characters", sharedId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    currentCharacterId = sharedId;
                    localStorage.setItem('dnd_char_id', currentCharacterId);

                    const data = docSnap.data();
                    populateData(data.sheetData);
                    lastLoadedRemoteTimestamp = new Date(data.lastUpdated).getTime();

                    if (currentUser && data.ownerId === currentUser.uid) {
                        setupRealtimeListener();
                    } else {
                        isCloudOwner = false;
                        document.getElementById('status').innerText = "Read Only Mode";
                    }
                } else {
                    alert("Character not found.");
                }
            } catch (e) { console.error(e); }
            finally { isLoading = false; updateModifiers(); }
        }

        async function updateSnapshotSelect() {
            if (!currentUser) return;

            const snapshotsCol = getSnapshotsCollection(currentUser.uid);
            try {
                // Now 'await' will work correctly
                const snapDocs = await getDocs(snapshotsCol);
                const select = document.getElementById('versionSelect');

                // Clear existing options except the placeholder
                select.innerHTML = '<option value="">Load Version...</option>';

                snapDocs.forEach(d => {
                    const data = d.data();
                    const opt = document.createElement('option');
                    opt.value = d.id; // This is the Firestore Document ID

                    // Format the date for a better UI experience
                    const date = data.createdAt ? new Date(data.createdAt).toLocaleDateString() : 'Unknown Date';
                    opt.text = `${data.name} (${date})`;

                    select.appendChild(opt);
                });
            } catch(e) {
                console.error("Snapshot load error:", e);
            }
        }

        // --- DATA COLLECTION ---
        function collectData() {
            const data = { charName: document.getElementById('charName').value }; // Ensure name is top level
            document.querySelectorAll('input[id], textarea[id], select[id]').forEach(el => {
                data[el.id] = (el.type === 'checkbox') ? el.checked : el.value;
            });
            data['weapons'] = [];
            document.querySelectorAll('#weapons-body tr').forEach(tr => {
                const i = tr.querySelectorAll('input');
                data['weapons'].push({name: i[0].value, atk: i[1].value, dmg: i[2].value, notes: i[3].value});
            });
            data['spells'] = [];
            document.querySelectorAll('#spells-body tr').forEach(tr => {
                const i = tr.querySelectorAll('input');
                data['spells'].push({lvl: i[0].value, name: i[1].value, conc: i[2].checked, rit: i[3].checked, mat: i[4].checked});
            });
            data['spellSlots'] = {};
            document.querySelectorAll('.spell-slots-grid input[type="checkbox"]').forEach(cb => { data['spellSlots'][cb.id] = cb.checked; });
            return data;
        }

        function populateData(data) {
            if(!data) return;
            for (const [key, value] of Object.entries(data)) {
                if(key === 'spellSlots' || key === 'weapons' || key === 'spells') continue;
                const el = document.getElementById(key);
                if (el) { if(el.type === 'checkbox') el.checked = value; else el.value = value; }
            }
            if(data.weapons) {
                document.getElementById('weapons-body').innerHTML = '';
                for(let i=0; i<Math.max(5, data.weapons.length); i++) window.addWeaponRow();
                const rows = document.querySelectorAll('#weapons-body tr');
                data.weapons.forEach((r, i) => { if(rows[i]) { let inputs = rows[i].querySelectorAll('input'); inputs[0].value=r.name; inputs[1].value=r.atk; inputs[2].value=r.dmg; inputs[3].value=r.notes; }});
            }
            if(data.spells) {
                document.getElementById('spells-body').innerHTML = '';
                for(let i=0; i<Math.max(15, data.spells.length); i++) window.addSpellRow();
                const rows = document.querySelectorAll('#spells-body tr');
                data.spells.forEach((r, i) => { if(rows[i]) { let inputs = rows[i].querySelectorAll('input'); inputs[0].value=r.lvl; inputs[1].value=r.name; inputs[2].checked=r.conc; inputs[3].checked=r.rit; inputs[4].checked=r.mat; }});
            }
            if(data.spellSlots) {
                for (const [slotId, checked] of Object.entries(data.spellSlots)) {
                    const el = document.getElementById(slotId);
                    if(el) el.checked = checked;
                }
            }
            updateModifiers();
            updatePageTitle();
        }

        // --- HELPERS ---
        function updateModifiers() {
            const stats = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
            const profBonus = parseInt(document.getElementById('prof-bonus').value) || 0;
            stats.forEach(stat => {
                const scoreEl = document.getElementById(`${stat}-score`);
                const modEl = document.getElementById(`${stat}-mod`);
                if (scoreEl && modEl) {
                   const score = parseInt(scoreEl.value);
                   if (isNaN(score)) { modEl.value = ""; } else {
                       const mod = Math.floor((score - 10) / 2);
                       modEl.value = (mod >= 0 ? "+" : "") + mod;
                       const saveProf = document.getElementById(`save-prof-${stat}`).checked;
                       const saveVal = document.getElementById(`save-val-${stat}`);
                       const totalSave = mod + (saveProf ? profBonus : 0);
                       saveVal.value = (totalSave >= 0 ? "+" : "") + totalSave;
                       document.querySelectorAll(`[id^="val-${stat}-"]`).forEach(skillInput => {
                           const skillId = skillInput.id.replace('val-', 'prof-');
                           const isProficient = document.getElementById(skillId).checked;
                           const totalSkill = mod + (isProficient ? profBonus : 0);
                           skillInput.value = (totalSkill >= 0 ? "+" : "") + totalSkill;
                       });
                    }
                }
            });
            // Spell Mods
            const selectedStat = document.getElementById('spell-ability').value;
            if (selectedStat) {
                const scoreEl = document.getElementById(`${selectedStat}-score`);
                const mod = Math.floor((parseInt(scoreEl.value || 10) - 10) / 2);
                document.getElementById('spell-mod').value = (mod >= 0 ? "+" : "") + mod;
                document.getElementById('spell-save-dc').value = 8 + profBonus + mod;
                document.getElementById('spell-atk').value = (profBonus + mod >= 0 ? "+" : "") + (profBonus + mod);
            }
            const percVal = parseInt(document.getElementById('val-wisdom-perception').value) || 0;
            const passPercEl = document.getElementById('pass-perc');
            if (passPercEl) passPercEl.value = 10 + percVal;
        }

        function handleInput(e) {
            if (e.target.id.endsWith('-score') || e.target.id === 'prof-bonus' || e.target.type === 'checkbox' || e.target.id === 'spell-ability') {
                updateModifiers();
            }
            if (!isLoading) {
                lastLocalChangeTimestamp = Date.now();
                // Debounce saving: updates Head doc (and potentially creates snapshot)
                debounce(() => window.saveVersion(false), 2000)();
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }

        function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (c=='x'?Math.random()*16|0:(Math.random()*16|0)&0x3|0x8).toString(16)); }
        function updatePageTitle() {
             const name = document.getElementById('charName').value;
             if(name) document.title = name + " - 5e";
        }

        window.shareSheet = async function() {
            if (!currentUser) { alert("Login required."); return; }
            await window.saveVersion(false); // Ensure head is up to date
            const shareUrl = `${window.location.origin}${window.location.pathname}?charId=${currentCharacterId}`;
            try { await navigator.clipboard.writeText(shareUrl); alert("Link copied!"); } catch (err) { prompt("Copy:", shareUrl); }
        }

        window.addWeaponRow = () => {
            const tbody = document.getElementById('weapons-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td>`;
            tbody.appendChild(tr);
            tr.querySelectorAll('input').forEach(i => i.addEventListener('input', handleInput));
        };
        window.addSpellRow = () => {
             const tbody = document.getElementById('spells-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><input type="text" style="width:25px; text-align:center;"></td><td><input type="text"></td><td style="white-space: nowrap; text-align: center;"><input type="checkbox" class="diamond-check"><input type="checkbox" class="diamond-check"><input type="checkbox" class="diamond-check"><input type="checkbox" class="diamond-check"><input type="checkbox" class="diamond-check"></td>`;
            tbody.appendChild(tr);
            tr.querySelectorAll('input').forEach(i => i.addEventListener('input', handleInput));
        };
        window.resetSheet = function() {
            if(confirm("Create new character? Unsaved changes will be lost.")) {
                currentCharacterId = generateUUID();
                localStorage.setItem('dnd_char_id', currentCharacterId);
                window.location.href = window.location.pathname; // Reload clean
            }
        };

        function generateStaticContent() {
            const abilityData = { "Strength": ["Athletics"], "Dexterity": ["Acrobatics", "Sleight of Hand", "Stealth"], "Constitution": [], "Intelligence": ["Arcana", "History", "Investigation", "Nature", "Religion"], "Wisdom": ["Animal Handling", "Insight", "Medicine", "Perception", "Survival"], "Charisma": ["Deception", "Intimidation", "Performance", "Persuasion"] };
            const abilitiesContainer = document.getElementById('ability-scores-container');
            if(abilitiesContainer) {
                let html = '';
                for (const [stat, skills] of Object.entries(abilityData)) {
                    const lowStat = stat.toLowerCase();
                    let skillsHtml = '';
                    skills.forEach(skill => {
                        const skillId = skill.replace(/\s+/g, '-').toLowerCase();
                        skillsHtml += `<div class="skill-row"><input type="number" class="save-val-input" id="val-${lowStat}-${skillId}" placeholder="0"><input type="checkbox" class="prof-bubble" id="prof-${lowStat}-${skillId}"><span>${skill}</span></div>`;
                    });
                    html += `<div class="ability-box"><span class="box-title" data-tip="${stat}" tabindex="0">${stat}</span><div style="position: relative;"><input type="number" id="${lowStat}-score" class="ability-score" placeholder="10"><span class="label-sm">Score</span><input type="text" id="${lowStat}-mod" class="ability-mod" placeholder="+0"><span class="label-sm">Modifier</span></div><div class="skills-list"><div class="skill-row" style="font-weight: bold; border-bottom: 2px solid #ccc;"><input type="text" class="save-val-input" id="save-val-${lowStat}" placeholder="0"><input type="checkbox" class="prof-bubble" id="save-prof-${lowStat}"><span>Saving Throw</span></div>${skillsHtml}</div></div>`;
                }
                abilitiesContainer.innerHTML = html;
            }
            const slotContainer = document.getElementById('spell-slots-container');
            if(slotContainer) {
                const slotCounts = [0, 4, 3, 3, 3, 3, 2, 2, 1, 1];
                let html = '';
                for(let i=1; i<=9; i++) {
                    html += `<div>${i}${i===1?'st':i===2?'nd':i===3?'rd':'th'} `;
                    for(let j=0; j<slotCounts[i]; j++) html += `<input type="checkbox" class="diamond-check" id="slot-${i}-${j}">`;
                    html += `</div>`;
                }
                slotContainer.innerHTML = html;
            }
        }

        // --- TOOLTIPS ---
         window.toggleTips = () => {
             tipsEnabled = !tipsEnabled;
             const btn = document.getElementById('toggle-tips');
             document.body.classList.toggle('tips-enabled', tipsEnabled);
             btn.innerText = `Tips: ${tipsEnabled ? 'ON' : 'OFF'}`;
             btn.style.background = tipsEnabled ? '#4a5568' : '#222';
         };

        const tooltipEl = document.getElementById('ai-tooltip');
        let currentTarget = null;
        function showTip(e, text, title) {
            if (!tipsEnabled || !text || text.length === 0) return;
            const quote = text[Math.floor(Math.random() * text.length)];
            tooltipEl.innerHTML = `<strong>${title}</strong>${quote}`;
            tooltipEl.style.opacity = '1';
            moveTip(e);
        }

        function moveTip(e) {
            if (!e.clientX) return; // Guard for keyboard events mostly
            const x = e.clientX + 15;
            const y = e.clientY + 15;
            const rect = tooltipEl.getBoundingClientRect();
            const safeX = (x + rect.width > window.innerWidth) ? x - rect.width - 20 : x;
            const safeY = (y + rect.height > window.innerHeight) ? y - rect.height - 20 : y;
            tooltipEl.style.left = `${safeX}px`;
            tooltipEl.style.top = `${safeY}px`;
        }

        function hideTip() {
            tooltipEl.style.opacity = '0';
            currentTarget = null;
        }

        // Helper to find matches in dictionary (case-insensitive)
        function getMatch(str) {
            const search = str.trim().toLowerCase();
            const key = Object.keys(AI_COMMENTS).find(k => k.toLowerCase() === search);
            return key ? { title: key, text: AI_COMMENTS[key] } : null;
        }

        async function setupTooltips() {
            try {
                const response = await fetch('./ai_comments.json');
                if (!response.ok) throw new Error('Failed to load AI comments');
                AI_COMMENTS = await response.json();
            } catch (err) {
                console.error("Tooltip data error:", err);
                return;
            }

            // Accessibility
            document.body.addEventListener('focusin', (e) => {
                 const target = e.target.closest('[data-tip]');
                 if (target && AI_COMMENTS[target.dataset.tip]) {
                    const rect = target.getBoundingClientRect();
                    showTip({ clientX: rect.right, clientY: rect.bottom }, AI_COMMENTS[target.dataset.tip], target.dataset.tip);
                 }
            });
            document.body.addEventListener('focusout', hideTip);
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            generateStaticContent();
            await setupTooltips();

            document.body.addEventListener('mouseover', (e) => {
                const target = e.target.closest('[data-tip]');
                if (target) {
                    const match = getMatch(target.dataset.tip);
                    if (match) {
                        currentTarget = target;
                        showTip(e, match.text, match.title);
                    }
                }
            });
            document.body.addEventListener('mousemove', (e) => { if (currentTarget) moveTip(e); });
            document.body.addEventListener('mouseout', (e) => { if (e.target.closest('[data-tip]')) hideTip(); });

            const allInputs = document.querySelectorAll('input, textarea, select');
            allInputs.forEach(input => { input.addEventListener('input', handleInput); });

            const urlParams = new URLSearchParams(window.location.search);
            const sharedId = urlParams.get('charId');

            if (sharedId) {
                await loadSharedCharacter(sharedId);
            } else {
                // If local storage has a backup, maybe use it?
                // For this migration, we rely on Cloud first if logged in.
            }
        });
    </script>
</body>
</html>
