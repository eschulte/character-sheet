<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="D&D 5e Character Sheet PWA">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>5e Character Sheet</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fdf6e3">
    <style>
        /* [KEEPING YOUR EXISTING CSS UNCHANGED] */
        :root { --bg-color: #fdf6e3; --text-color: #2b2b2b; --border-color: #5c4b3f; --faint-line: #dcd6c7; }
        * { box-sizing: border-box; }
        body { font-family: 'Georgia', 'Times New Roman', serif; background-color: #222; margin: 0; padding: 20px; color: var(--text-color); display: flex; justify-content: center; }
        #app-controls { position: absolute; top: 0; left: 0; width: 100%; background: #333; color: white; padding: 10px; display: flex; flex-wrap: wrap; gap: 10px; z-index: 1000; font-family: sans-serif; align-items: center; }
        button { padding: 5px 10px; cursor: pointer; background: #555; color: white; border: 1px solid #777; }
        @media print { #app-controls { display: none !important; } body { background: white; padding: 0; display: block; } .sheet-container { width: 100%; max-width: 100%; box-shadow: none; padding: 0; margin: 0; } textarea { border: 1px solid #ccc; } }
        .sheet-container { background-color: var(--bg-color); width: 100%; max-width: 950px; padding: 40px; box-shadow: 0 0 15px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 20px; margin-top: 40px; }
        input[type="text"], input[type="number"], textarea { background: transparent; border: none; border-bottom: 1px solid var(--border-color); width: 100%; font-family: inherit; font-size: 1rem; color: var(--text-color); }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
        @media (hover: hover) { input[type="number"]:hover::-webkit-outer-spin-button, input[type="number"]:hover::-webkit-inner-spin-button { -webkit-appearance: auto; } input[type="number"]:hover { -moz-appearance: number-input; } }
        textarea { resize: vertical; border: 1px solid var(--faint-line); padding: 5px; }
        .label-sm { font-size: 0.7rem; text-transform: uppercase; color: #666; font-family: sans-serif; display: block; margin-top: 2px;}
        .main-header { display: grid; grid-template-columns: 2.5fr 1fr 1fr 1fr; gap: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 20px; }
        .header-section { display: flex; flex-direction: column; justify-content: flex-end; }
        .main-grid { display: grid; grid-template-columns: 1fr 2.6fr; gap: 25px; }
        .stats-col { display: flex; flex-direction: column; gap: 15px; }
        .ability-box { border: 2px solid var(--border-color); border-radius: 10px; padding: 10px 5px; text-align: center; background: rgba(255,255,255,0.3); }
        .ability-score { font-size: 1.5rem; font-weight: bold; width: 50px; margin: 0 auto; display: block; text-align: center; border: 1px solid #ccc; border-radius: 5px; }
        .ability-mod { font-size: 2rem; font-weight: bold; border: none; text-align: center;}
        .skills-list { font-size: 0.85rem; text-align: left; margin-top: 15px; padding-left: 5px; }
        .skill-row { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; border-bottom: 1px solid #eee; }
        .prof-bubble { width: 12px; height: 12px; border: 1px solid black; border-radius: 50%; appearance: none; cursor: pointer; flex-shrink: 0; }
        .prof-bubble:checked { background: black; }
        .save-val-input { width: 25px !important; text-align: center; font-size: 0.8rem; margin-right: 5px; border-bottom: 1px solid #999 !important; }
        .combat-row-1 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .combat-row-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 20px; }
        .shield-box { border: 2px double var(--border-color); padding: 5px; text-align: center; border-radius: 5px 5px 50% 50%; display: flex; flex-direction: column; justify-content: center; }
        .rect-box { border: 2px double var(--border-color); padding: 5px; border-radius: 5px; display: flex; flex-direction: column; }
        .box-title { font-family: sans-serif; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; text-align: center; margin-bottom: 5px;}
        .death-save-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; margin-top: 5px; }
        .ds-bubbles { display: flex; gap: 5px; }
        .physical-traits-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 5px; }
        .trait-item { text-align: center; }
        .weapons-table, .spells-list-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .weapons-table th, .spells-list-table th { text-align: left; border-bottom: 2px solid var(--border-color); font-size: 0.8rem; }
        .weapons-table td, .spells-list-table td { border-bottom: 1px solid var(--faint-line); padding: 5px 0; }
        .bottom-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .tall-box { height: 200px; display: flex; flex-direction: column;}
        .panel { border: 2px solid var(--border-color); border-radius: 5px; padding: 10px; }
        .prof-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem; margin-bottom: 10px; }
        .prof-check-row { display: flex; gap: 10px; align-items: center; }
        .spell-grid-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-top: 20px; border-top: 3px double var(--border-color); padding-top: 20px; }
        .spell-header { display: grid; grid-template-columns: 1.5fr 3.5fr; gap: 15px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .spell-stats-box { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .spell-stat-item { border: 1px solid var(--border-color); border-radius: 5px; padding: 5px; text-align: center; }
        .spell-slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px 5px; font-size: 0.8rem; white-space: nowrap; }
        .diamond-check { appearance: none; width: 12px; height: 12px; border: 1px solid black; transform: rotate(45deg); margin: 2px 3px; cursor: pointer; display: inline-block; vertical-align: middle; }
        .diamond-check:checked { background: black; }
        .bio-col { display: flex; flex-direction: column; gap: 15px; height: 100%; }
        .coins-container { border: 2px solid var(--border-color); padding: 5px; border-radius: 10px; display: flex; flex-direction: column; }
        .coins { display: flex; gap: 5px; justify-content: space-around; }
        .coin-slot input { width: 40px; text-align: center; }
        
        @media screen and (max-width: 768px) {
            body { display: block; padding: 0; }
            #app-controls { position: absolute; }
            .sheet-container { margin-top: 0; padding: 10px; padding-top: 110px; border-radius: 0; box-shadow: none; }
            .main-grid, .spell-grid-layout, .main-header, .combat-row-1, .combat-row-2, .spell-header, .bottom-sections, .prof-grid { display: flex; flex-direction: column; }
            #status { margin-left: 0; width: 100%; }
        }
    </style>
</head>
<body>

    <div id="app-controls">
        <span><b>D&D 5e</b></span>
        <button id="auth-btn">Login with Google</button>
        <button onclick="saveVersion()">Save Snapshot</button>
        <select id="versionSelect" onchange="loadSelectedVersion()">
            <option value="">Load Version...</option>
        </select>
        <button onclick="resetSheet()" style="background: #800;">Reset</button>
        <button onclick="window.print()" style="background: #005f80;">Print</button>
        <button onclick="shareSheet()" style="background: #28a745;">Share URL</button>
        <span id="status" style="font-size: 0.8rem; color: #aaa; margin-left: auto;">Offline Mode</span>
    </div>

    <div class="sheet-container">
        <div class="main-header">
            <div class="header-section">
                <input type="text" id="charName" placeholder="Character Name" style="font-size: 1.5rem; font-weight: bold;">
                <span class="label-sm">Character Name</span>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <div style="flex: 1;">
                        <input type="text" id="species" placeholder="Species">
                        <span class="label-sm">Species</span>
                    </div>
                    <div style="flex: 1;">
                        <input type="text" id="background" placeholder="Background">
                        <span class="label-sm">Background</span>
                    </div>
                </div>
            </div>
            <div class="header-section">
                <input type="text" id="class">
                <span class="label-sm">Class</span>
                <input type="text" id="subclass">
                <span class="label-sm">Subclass</span>
            </div>
            <div class="header-section">
                <input type="text" id="level">
                <span class="label-sm">Level</span>
                <input type="text" id="xp">
                <span class="label-sm">XP</span>
            </div>
            <div class="header-section">
                <div class="shield-box">
                    <span class="box-title">Armor Class</span>
                    <input type="number" id="ac" style="font-size: 1.5rem; text-align: center; border: none;">
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="stats-col">
                <div class="ability-box">
                    <span class="box-title">Prof. Bonus</span>
                    <input type="text" id="prof-bonus" style="font-size: 1.5rem; text-align: center; border:none;">
                </div>
                <div id="ability-scores-container"></div>
            </div>

            <div class="main-col">
                <div class="combat-row-1">
                    <div class="shield-box"><span class="box-title">Initiative</span><input type="text" id="initiative" placeholder="d20 + dex mod" style="text-align: center; font-size: 1rem;"></div>
                    <div class="shield-box"><span class="box-title">Speed</span><input type="text" id="speed" style="text-align: center; font-size: 1rem;"></div>
                    <div class="shield-box"><span class="box-title">Size</span><input type="text" id="size" style="text-align: center; font-size: 1rem;"></div>
                    <div class="shield-box"><span class="box-title">Passive Perc.</span><input type="text" id="pass-perc" style="text-align: center; font-size: 1rem;"></div>
                </div>

                <div class="combat-row-2">
                    <div class="rect-box">
                        <span class="box-title">Hit Points</span>
                        <div style="display: flex; gap: 10px; height: 100%;">
                            <div style="flex:1; text-align: center;"><input type="number" id="hp-max" placeholder="Max" style="text-align:center;"><span class="label-sm">Max</span></div>
                            <div style="flex:1; text-align: center;"><input type="number" id="hp-curr" placeholder="Current" style="text-align:center; font-size: 1.2rem; font-weight: bold;"><span class="label-sm">Current</span></div>
                            <div style="flex:1; text-align: center;"><input type="number" id="hp-temp" placeholder="Temp" style="text-align:center;"><span class="label-sm">Temp</span></div>
                        </div>
                    </div>
                    <div class="rect-box">
                        <span class="box-title">Death Saves</span>
                        <div class="death-save-row"><span>Successes</span><div class="ds-bubbles"><input type="checkbox" class="prof-bubble" id="ds-s-1"><input type="checkbox" class="prof-bubble" id="ds-s-2"><input type="checkbox" class="prof-bubble" id="ds-s-3"></div></div>
                        <div class="death-save-row"><span>Failures</span><div class="ds-bubbles"><input type="checkbox" class="prof-bubble" id="ds-f-1"><input type="checkbox" class="prof-bubble" id="ds-f-2"><input type="checkbox" class="prof-bubble" id="ds-f-3"></div></div>
                    </div>
                </div>

                <div class="panel" style="margin-bottom: 15px;">
                    <span class="box-title">Physical Characteristics</span>
                    <div class="physical-traits-grid">
                        <div class="trait-item"><input type="text" id="age" placeholder="25"><span class="label-sm">Age</span></div>
                        <div class="trait-item"><input type="text" id="height" placeholder="5'10"><span class="label-sm">Height</span></div>
                        <div class="trait-item"><input type="text" id="weight" placeholder="160 lbs"><span class="label-sm">Weight</span></div>
                    </div>
                    <div class="physical-traits-grid">
                        <div class="trait-item"><input type="text" id="eyes" placeholder="Blue"><span class="label-sm">Eyes</span></div>
                        <div class="trait-item"><input type="text" id="skin" placeholder="Fair"><span class="label-sm">Skin</span></div>
                        <div class="trait-item"><input type="text" id="hair" placeholder="Brown"><span class="label-sm">Hair</span></div>
                    </div>
                </div>

                <div class="panel">
                    <span class="box-title">Weapons & Damage Cantrips</span>
                    <table class="weapons-table">
                        <thead><tr><th>Name</th><th>Atk/DC</th><th>Damage</th><th>Notes</th></tr></thead>
                        <tbody id="weapons-body"></tbody>
                    </table>
                    <button onclick="addWeaponRow()" style="width: 100%;">+</button>
                </div>

                <div class="panel" style="margin-top: 10px;">
                    <span class="box-title">Proficiencies & Training</span>
                    <div style="margin-bottom: 5px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                        <span class="label-sm" style="display:inline; margin-right: 10px;">Armor:</span>
                        <label><input type="checkbox" id="prof-armor-light"> Light</label> &nbsp;
                        <label><input type="checkbox" id="prof-armor-medium"> Medium</label> &nbsp;
                        <label><input type="checkbox" id="prof-armor-heavy"> Heavy</label> &nbsp; | &nbsp;
                        <label><input type="checkbox" id="prof-shields"> Shields</label>
                    </div>
                    <div class="prof-grid">
                        <div><span class="label-sm">Weapons</span><textarea id="prof-weapons-text" style="height: 240px;"></textarea></div>
                        <div><span class="label-sm">Tools</span><textarea id="prof-tools-text" style="height: 240px;"></textarea></div>
                    </div>
                </div>

                <div class="panel" style="margin-top: 10px;">
                    <span class="box-title">Class Features</span>
                    <textarea id="class-features" style="height: 120px; border:none;"></textarea>
                </div>

                <div class="panel" style="margin-top: 10px;">
                    <span class="box-title">Background Features</span>
                    <textarea id="background-features" style="height: 100px; border:none;"></textarea>
                </div>

                <div class="bottom-sections">
                    <div class="panel tall-box"><span class="box-title">Species Traits</span><textarea id="species-traits" style="height: 100%; border:none;"></textarea></div>
                    <div class="panel tall-box"><span class="box-title">Feats</span><textarea id="feats" style="height: 100%; border:none;"></textarea></div>
                </div>

            </div>
        </div>

        <div class="spell-grid-layout">
            <div>
                <div class="spell-header">
                    <div class="panel">
                        <span class="box-title" style="margin-bottom: 10px; display:block;">Spellcasting</span>
                        <div class="spell-stats-box">
                            <div class="spell-stat-item">
                                <span class="label-sm">Ability</span>
                                <select id="spell-ability" style="width: 100%; background: transparent; border: none; border-bottom: 1px solid var(--border-color); text-align: center; font-family: inherit;">
                                    <option value="">None</option>
                                    <option value="strength">Str</option>
                                    <option value="dexterity">Dex</option>
                                    <option value="constitution">Con</option>
                                    <option value="intelligence">Int</option>
                                    <option value="wisdom">Wis</option>
                                    <option value="charisma">Cha</option>
                                </select>
                            </div>
                            <div class="spell-stat-item"><span class="label-sm">Modifier</span><input type="text" id="spell-mod" style="text-align:center;"></div>
                            <div class="spell-stat-item"><span class="label-sm">Save DC</span><input type="text" id="spell-save-dc" style="text-align:center;"></div>
                            <div class="spell-stat-item"><span class="label-sm">Atk Bonus</span><input type="text" id="spell-atk" style="text-align:center;"></div>
                        </div>
                    </div>
                    <div class="panel">
                        <span class="box-title">Spell Slots</span>
                        <div class="spell-slots-grid" id="spell-slots-container"></div>
                    </div>
                </div>

                <div class="panel">
                    <span class="box-title">Cantrips & Prepared Spells</span>
                    <table class="spells-list-table">
                        <thead><tr><th width="30">Lvl</th><th>Name</th><th width="120" style="text-align: center;"><span title="Verbal, Somatic, Concentration, Ritual, Required Material">V / S / C / R / M</span></th></tr></thead>
                        <tbody id="spells-body"></tbody>
                    </table>
                    <button onclick="addSpellRow()" style="width: 100%;">+</button>
                </div>
            </div>

            <div class="bio-col">
                <div class="panel"><span class="box-title">Appearance</span><textarea id="appearance" style="height: 120px; border:none;"></textarea></div>
                <div class="panel" style="height: 250px; display: flex; flex-direction: column;">
                    <span class="box-title">Backstory & Personality</span>
                    <textarea id="backstory" style="flex-grow: 1; border:none;"></textarea>
                    <div style="margin-top: 5px; border-top: 1px solid #ccc; padding-top: 5px;">
                        <span class="label-sm" style="display:inline;">Alignment:</span>
                        <input type="text" id="alignment" style="width: 70%; display:inline-block;">
                    </div>
                </div>
                <div class="panel"><span class="box-title">Languages</span><textarea id="languages" style="height: 50px; border:none;"></textarea></div>
                <div class="panel" style="flex-grow: 1; min-height: 300px;"><span class="box-title">Equipment</span><textarea id="equipment" style="height: 100%; border:none;"></textarea></div>
                <div class="coins-container">
                    <span class="box-title">COINS</span>
                    <div class="coins">
                        <div class="coin-slot"><span class="label-sm">CP</span><input type="number" id="cp"></div>
                        <div class="coin-slot"><span class="label-sm">SP</span><input type="number" id="sp"></div>
                        <div class="coin-slot"><span class="label-sm">EP</span><input type="number" id="ep"></div>
                        <div class="coin-slot"><span class="label-sm">GP</span><input type="number" id="gp"></div>
                        <div class="coin-slot"><span class="label-sm">PP</span><input type="number" id="pp"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyAMfAkyUevv3BDKSO3yBjRra3jZ_uV5OlA",
          authDomain: "dnd-character-sheet-5e.firebaseapp.com",
          projectId: "dnd-character-sheet-5e",
          storageBucket: "dnd-character-sheet-5e.firebasestorage.app",
          messagingSenderId: "554732035132",
          appId: "1:554732035132:web:ed89be7af2ceea147a7739"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let currentCharacterId = localStorage.getItem('dnd_char_id') || generateUUID();
        let isCloudOwner = true; // Defaults to true until we load a shared sheet

        // Store ID immediately if it was new
        localStorage.setItem('dnd_char_id', currentCharacterId);

        // --- AUTH EXPORTS ---
        window.login = async () => {
            try { await signInWithPopup(auth, provider); } 
            catch (error) { alert("Login failed: " + error.message); }
        };

        window.logout = () => {
            signOut(auth);
            window.location.reload(); // Refresh to clear user state
        };

        onAuthStateChanged(auth, (user) => {
            const authBtn = document.getElementById('auth-btn');
            const statusEl = document.getElementById('status');
            if (user) {
                currentUser = user;
                authBtn.innerText = `Logout (${user.displayName.split(' ')[0]})`;
                authBtn.onclick = window.logout;

                // If we are viewing our own sheet, try to sync
                if (isCloudOwner) {
                    statusEl.innerText = "Online - Syncing...";
                    saveToCloud(); // Push any local offline changes to cloud
                }
            } else {
                currentUser = null;
                authBtn.innerText = "Login with Google";
                authBtn.onclick = window.login;
                statusEl.innerText = "Offline Mode (Local Storage)";
            }
        });

        // --- CLOUD SYNC LOGIC ---
        
        // 1. Save to Cloud (Only if we are the owner)
        async function saveToCloud() {
            if (!currentUser || !isCloudOwner) return;

            const data = collectData();
            const statusEl = document.getElementById('status');

            try {
                // We use a root collection 'characters' for easier shared access
                await setDoc(doc(db, "characters", currentCharacterId), {
                    lastUpdated: new Date().toISOString(),
                    sheetData: data,
                    ownerId: currentUser.uid, // Important for Security Rules
                    ownerEmail: currentUser.email,
                    characterName: data.charName || "Unnamed"
                }, { merge: true });

                statusEl.innerText = 'Cloud Synced ' + new Date().toLocaleTimeString();
                statusEl.style.color = '#28a745'; // Green
            } catch (e) {
                console.error("Cloud save error:", e);
                statusEl.innerText = 'Sync Failed (Offline?)';
                statusEl.style.color = '#dc3545'; // Red
            }
        }

        // 2. Load Shared Character (Read-Only Mode)
        async function loadSharedCharacter(sharedId) {
            const statusEl = document.getElementById('status');
            statusEl.innerText = "Loading Shared Sheet...";
            
            try {
                const docRef = doc(db, "characters", sharedId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Check ownership
                    if (currentUser && data.ownerId === currentUser.uid) {
                        isCloudOwner = true;
                        statusEl.innerText = "Loaded Your Cloud Sheet";
                    } else {
                        isCloudOwner = false;
                        statusEl.innerText = "Viewing Shared Sheet (Read Only)";
                        // Visual indicator that this is read-only
                        document.getElementById('app-controls').style.borderBottom = "3px solid orange";
                        alert("You are viewing a shared character. Changes will NOT save to the cloud unless you copy it.");
                    }

                    populateData(data.sheetData);
                    // Update current ID to match the shared one so we don't overwrite our local "default" immediately
                    currentCharacterId = sharedId; 
                    updatePageTitle();
                    return true;
                } else {
                    alert("Character not found or deleted.");
                    return false;
                }
            } catch (e) {
                console.error("Load error:", e);
                alert("Could not load character. Check your internet connection.");
                return false;
            }
        }

        // --- EVENT LISTENERS ---
        
        // Sync when internet comes back
        window.addEventListener('online', () => {
            document.getElementById('status').innerText = "Back Online!";
            saveToCloud();
        });

        window.addEventListener('offline', () => {
             document.getElementById('status').innerText = "You are Offline";
        });

        // --- UTILITY EXPORTS ---
        window.shareSheet = async function() {
            // New Sharing Logic: Share the ID, not the data
            if (!currentUser) {
                alert("You must be logged in to generate a cloud link.");
                return;
            }
            // Ensure latest data is in cloud before sharing
            await saveToCloud();
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?charId=${currentCharacterId}`;

            try {
                await navigator.clipboard.writeText(shareUrl);
                alert("Cloud Link copied! \nAnyone with this link can view (but not edit) this character.");
            } catch (err) {
                prompt("Copy this link:", shareUrl);
            }
        }

        // ... [KEEP YOUR EXISTING window.addWeaponRow, window.addSpellRow, etc. HERE] ...
        // (Paste the existing helper functions from the previous version: addWeaponRow, addSpellRow, saveVersion, loadSelectedVersion, resetSheet)

        window.addWeaponRow = function() {
            const tbody = document.getElementById('weapons-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td>`;
            tbody.appendChild(tr);
            tr.querySelectorAll('input').forEach(i => i.addEventListener('input', debounce(handleAutoSave, 1000)));
        }

        window.addSpellRow = function() {
            const tbody = document.getElementById('spells-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" style="width:25px; text-align:center;"></td>
                <td><input type="text"></td>
                <td style="white-space: nowrap; text-align: center;">
                    <input type="checkbox" class="diamond-check" title="Verbal">
                    <input type="checkbox" class="diamond-check" title="Somatic">
                    <input type="checkbox" class="diamond-check" title="Concentration">
                    <input type="checkbox" class="diamond-check" title="Ritual">
                    <input type="checkbox" class="diamond-check" title="Material">
                </td>`;
            tbody.appendChild(tr);
            tr.querySelectorAll('input').forEach(i => i.addEventListener('input', debounce(handleAutoSave, 1000)));
        }

        window.saveVersion = function() {
            const name = prompt("Version Name:");
            if(!name) return;
            let versions = JSON.parse(localStorage.getItem('dnd_versions') || "[]");
            versions.push({ name: name, timestamp: new Date().toISOString(), data: collectData() });
            localStorage.setItem('dnd_versions', JSON.stringify(versions));
            updateVersionDropdown();
        }

        window.loadSelectedVersion = function() {
            const idx = document.getElementById('versionSelect').value;
            if(idx === "") return;
            if(confirm("Overwrite current data?")) {
                populateData(JSON.parse(localStorage.getItem('dnd_versions'))[idx].data);
                handleAutoSave();
            }
        }

        window.resetSheet = function() {
            if(confirm("Clear all?")) {
                document.querySelectorAll('input').forEach(i => { if(i.type==='checkbox')i.checked=false; else i.value=""; });
                document.querySelectorAll('textarea').forEach(t=>t.value="");
                handleAutoSave();
            }
        }
        
        // --- INTERNAL HELPERS ---
        function updateModifiers() {
            const stats = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
            const profBonus = parseInt(document.getElementById('prof-bonus').value) || 0;

            stats.forEach(stat => {
                const scoreEl = document.getElementById(`${stat}-score`);
                const modEl = document.getElementById(`${stat}-mod`);

                if (scoreEl && modEl) {
                   const score = parseInt(scoreEl.value);
                   if (isNaN(score)) {
                       modEl.value = ""; 
                   } else {
                       const mod = Math.floor((score - 10) / 2);
                       modEl.value = (mod >= 0 ? "+" : "") + mod;

                       // Update Saving Throw
                       const saveProf = document.getElementById(`save-prof-${stat}`).checked;
                       const saveVal = document.getElementById(`save-val-${stat}`);
                       const totalSave = mod + (saveProf ? profBonus : 0);
                       saveVal.value = (totalSave >= 0 ? "+" : "") + totalSave;

                       // Update Associated Skills
                       const skillInputs = document.querySelectorAll(`[id^="val-${stat}-"]`);
                       skillInputs.forEach(skillInput => {
                           const skillId = skillInput.id.replace('val-', 'prof-');
                           const isProficient = document.getElementById(skillId).checked;
                           const totalSkill = mod + (isProficient ? profBonus : 0);
                           skillInput.value = (totalSkill >= 0 ? "+" : "") + totalSkill;
                       });
                    }
                }
            });

            // Update Spellcasting Stats
            const selectedStat = document.getElementById('spell-ability').value;
            if (selectedStat) {
                const scoreEl = document.getElementById(`${selectedStat}-score`);
                const mod = Math.floor((parseInt(scoreEl.value || 10) - 10) / 2);
                document.getElementById('spell-mod').value = (mod >= 0 ? "+" : "") + mod;
                document.getElementById('spell-save-dc').value = 8 + profBonus + mod;
                document.getElementById('spell-atk').value = (profBonus + mod >= 0 ? "+" : "") + (profBonus + mod);
            } else {
                document.getElementById('spell-mod').value = "";
                document.getElementById('spell-save-dc').value = "";
                document.getElementById('spell-atk').value = "";
            }

            // Update Passive Perception
            const percVal = parseInt(document.getElementById('val-wisdom-perception').value) || 0;
            const passPercEl = document.getElementById('pass-perc');
            if (passPercEl) {
                passPercEl.value = 10 + percVal;
            }
        }

        function handleAutoSave() {
            // 1. Always save to LocalStorage (Offline support)
            localStorage.setItem('dnd_current_sheet', JSON.stringify(collectData()));
            
            const statusEl = document.getElementById('status');
            // Only update text if we aren't currently running a cloud sync to avoid flickering
            if(!statusEl.innerText.includes('Sync')) {
                statusEl.innerText = 'Local Saved ' + new Date().toLocaleTimeString();
            }

            // 2. Try to Sync to Cloud (if owner and online)
            saveToCloud();
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // ... [KEEP YOUR EXISTING collectData, populateData, updateVersionDropdown, debounce, updatePageTitle HERE] ...
        // (Paste these exactly as they were in the previous working version)

        function collectData() {
            const data = {};
            document.querySelectorAll('input[id], textarea[id], select[id]').forEach(el => {
                data[el.id] = (el.type === 'checkbox') ? el.checked : el.value;
            });
            data['weapons'] = [];
            document.querySelectorAll('#weapons-body tr').forEach(tr => {
                const i = tr.querySelectorAll('input');
                data['weapons'].push({name: i[0].value, atk: i[1].value, dmg: i[2].value, notes: i[3].value});
            });
            data['spells'] = [];
            document.querySelectorAll('#spells-body tr').forEach(tr => {
                const i = tr.querySelectorAll('input');
                data['spells'].push({lvl: i[0].value, name: i[1].value, conc: i[2].checked, rit: i[3].checked, mat: i[4].checked});
            });
            data['spellSlots'] = {};
            document.querySelectorAll('.spell-slots-grid input[type="checkbox"]').forEach(cb => {
                data['spellSlots'][cb.id] = cb.checked;
            });
            return data;
        }

        function populateData(data) {
            if(!data) return;
            for (const [key, value] of Object.entries(data)) {
                if(key === 'spellSlots') continue;
                const el = document.getElementById(key);
                if (el) {
                    if(el.type === 'checkbox') el.checked = value;
                    else if(el.tagName === 'SELECT') el.value = value;
                    else el.value = value;
                }
            }
            if(data.weapons) {
                document.getElementById('weapons-body').innerHTML = '';
                for(let i=0; i<Math.max(5, data.weapons.length); i++) window.addWeaponRow();
                const rows = document.querySelectorAll('#weapons-body tr');
                data.weapons.forEach((r, i) => { if(rows[i]) { let inputs = rows[i].querySelectorAll('input'); inputs[0].value=r.name; inputs[1].value=r.atk; inputs[2].value=r.dmg; inputs[3].value=r.notes; }});
            }
            if(data.spells) {
                document.getElementById('spells-body').innerHTML = '';
                for(let i=0; i<Math.max(15, data.spells.length); i++) window.addSpellRow();
                const rows = document.querySelectorAll('#spells-body tr');
                data.spells.forEach((r, i) => { if(rows[i]) { let inputs = rows[i].querySelectorAll('input'); inputs[0].value=r.lvl; inputs[1].value=r.name; inputs[2].checked=r.conc; inputs[3].checked=r.rit; inputs[4].checked=r.mat; }});
            }
            if(data.spellSlots) {
                for (const [slotId, checked] of Object.entries(data.spellSlots)) {
                    const el = document.getElementById(slotId);
                    if(el) el.checked = checked;
                }
            }
        }

        function updateVersionDropdown() {
            const select = document.getElementById('versionSelect');
            select.innerHTML = '<option value="">Load Version...</option>';
            const versions = JSON.parse(localStorage.getItem('dnd_versions') || "[]");
            versions.forEach((v, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.text = `${v.name} (${new Date(v.timestamp).toLocaleDateString()})`;
                select.appendChild(opt);
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }

        function updatePageTitle() {
            const name = document.getElementById('charName').value.trim();
            const charClass = document.getElementById('class').value.trim();
            if (name && charClass) document.title = `${name} (${charClass}) - 5e`;
            else if (name) document.title = `${name} - 5e`;
        }

        // --- CONTENT GENERATION ---
        function generateStaticContent() {
             // 1. Ability Scores
            const abilityData = {
                "Strength": ["Athletics"], "Dexterity": ["Acrobatics", "Sleight of Hand", "Stealth"], "Constitution": [],
                "Intelligence": ["Arcana", "History", "Investigation", "Nature", "Religion"],
                "Wisdom": ["Animal Handling", "Insight", "Medicine", "Perception", "Survival"],
                "Charisma": ["Deception", "Intimidation", "Performance", "Persuasion"]
            };
            const abilitiesContainer = document.getElementById('ability-scores-container');
            if(abilitiesContainer) {
                let html = '';
                for (const [stat, skills] of Object.entries(abilityData)) {
                    const lowStat = stat.toLowerCase();
                    let skillsHtml = '';
                    skills.forEach(skill => {
                        const skillId = skill.replace(/\s+/g, '-').toLowerCase();
                        skillsHtml += `<div class="skill-row"><input type="number" class="save-val-input" id="val-${lowStat}-${skillId}" placeholder="0"><input type="checkbox" class="prof-bubble" id="prof-${lowStat}-${skillId}"><span>${skill}</span></div>`;
                    });
                    html += `
                    <div class="ability-box">
                        <span class="box-title">${stat}</span>
                        <div style="position: relative;">
                            <input type="number" id="${lowStat}-score" class="ability-score" placeholder="10"><span class="label-sm">Score</span>
                            <input type="text" id="${lowStat}-mod" class="ability-mod" placeholder="+0"><span class="label-sm">Modifier</span>
                        </div>
                        <div class="skills-list">
                            <div class="skill-row" style="font-weight: bold; border-bottom: 2px solid #ccc;">
                                <input type="text" class="save-val-input" id="save-val-${lowStat}" placeholder="0"><input type="checkbox" class="prof-bubble" id="save-prof-${lowStat}"><span>Saving Throw</span>
                            </div>${skillsHtml}
                        </div>
                    </div>`;
                }
                abilitiesContainer.innerHTML = html;
            }

            // 2. Spell Slots
            const slotContainer = document.getElementById('spell-slots-container');
            if(slotContainer) {
                const slotCounts = [0, 4, 3, 3, 3, 3, 2, 2, 1, 1];
                let html = '';
                for(let i=1; i<=9; i++) {
                    html += `<div>${i}${i===1?'st':i===2?'nd':i===3?'rd':'th'} `;
                    for(let j=0; j<slotCounts[i]; j++) html += `<input type="checkbox" class="diamond-check" id="slot-${i}-${j}">`;
                    html += `</div>`;
                }
                slotContainer.innerHTML = html;
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            generateStaticContent();
            
            for(let i=0; i<5; i++) window.addWeaponRow();
            for(let i=0; i<15; i++) window.addSpellRow();

            // Load logic: Check URL for ID first, otherwise load local
            const urlParams = new URLSearchParams(window.location.search);
            const sharedId = urlParams.get('charId');

            if (sharedId) {
                // If ID is in URL, fetch from cloud
                await loadSharedCharacter(sharedId);
            } else {
                // Otherwise load local storage
                const stored = localStorage.getItem('dnd_current_sheet');
                if(stored) populateData(JSON.parse(stored));
                updatePageTitle();
            }

            const allInputs = document.querySelectorAll('input, textarea, select');
            allInputs.forEach(input => {
                input.addEventListener('input', debounce(handleAutoSave, 1000));

                // Trigger math on Score, Prof Bonus, or Checkbox clicks
                if (input.id.endsWith('-score') || input.id === 'prof-bonus') {
                    input.addEventListener('input', updateModifiers);
                }
                if (input.id === 'spell-ability') {
                    input.addEventListener('change', updateModifiers);
                }
                if (input.type === 'checkbox' && (input.id.includes('prof-') || input.id.includes('save-prof-'))) {
                    input.onchange = updateModifiers;
                }

                input.addEventListener('change', handleAutoSave);
            });
            ['charName', 'class'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', updatePageTitle);
            });

            updateModifiers();
            updatePageTitle();
            updateVersionDropdown();

            if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW fail', err));
            }
        });
    </script>
  </body>
</html>
