<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="D&D 5e Character Sheet PWA">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/apple-touch-icon-180x180.png">
    <meta property="og:title" content="D&D 5e Character Sheet">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="/apple-touch-icon-180x180.png">
    <link rel="icon" href="/favicon.ico" sizes="48x48">
    <link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>5e Character Sheet</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fdf6e3">
    <style>
        :root { --bg-color: #fdf6e3; --text-color: #2b2b2b; --border-color: #5c4b3f; --faint-line: #dcd6c7; }
        * { box-sizing: border-box; }
        body { font-family: 'Georgia', 'Times New Roman', serif; background-color: #222; margin: 0; padding: 20px; color: var(--text-color); display: flex; flex-direction: column; align-items: center; width: 100%; min-height: 100vh; padding: 0; margin: 0; }
        #app-controls { position: sticky; top: 0; width: 100%; background: #2a2a2a; color: white; padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; z-index: 1001; font-family: sans-serif; align-items: center; transition: max-height 0.3s ease; overflow: visible; max-height: 50px; }
        #app-controls .app-btn { display: inline-block; transition: all 0.3s ease; }
        #app-controls.expanded { flex-wrap: wrap; max-height: 500px; }
        #app-controls button { padding: 3px 6px; font-size: 0.85rem; white-space: nowrap; }
        #app-toggle-hamburger { display: none; }
        .dropdown { position: relative; display: inline-block; z-index: 1002; }
        .dropdown-content {  display: none;  position: absolute;  background-color: #333;  min-width: 220px;  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);  z-index: 1001;  border: 1px solid #555;  padding: 10px;  border-radius: 4px;  top: 100%;  left: 0;  flex-direction: column; /* Ensure layout is vertical */ gap: 8px; }
        .dropdown-content.show { display: flex !important; }
        .dropdown:hover .dropdown-content { display: flex; flex-direction: column; gap: 8px; }
        .menu-group-label { font-size: 0.7rem; color: #aaa; text-transform: uppercase; margin-bottom: 2px; border-bottom: 1px solid #444; }
        .hidden-class-feature { display: none !important; }
        .class-badge { position: absolute; top: -2px; right: 2px; font-size: 1.1rem; opacity: 0.6; cursor: help; pointer-events: none; z-index: 10; }
        .counter-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .counter-label { font-size: 0.8rem; font-weight: bold; color: #555; }
        button { padding: 5px 10px; cursor: pointer; background: #555; color: white; border: 1px solid #777; }
        #portrait-container { width: 100%; height: 80px; /* Or your preferred height */ border: 2px solid var(--border-color); background: #eee; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; /* Clips the image if it's larger than the box */ cursor: pointer; }
        #portrait-container:hover #char-portrait { filter: brightness(0.8); }
        #portrait-url-container { display: none; margin-top: 8px; }
        #portrait-container.editing + #portrait-url-container { display: block; }
        #char-portrait { width: 100%; height: 100%; object-fit: cover; /* Resizes to fill box, cropping edges if necessary */ object-position: 33.33% center; /* Focuses on the top of the image (the face) */ transition: filter 0.2s; }
        #portrait-placeholder { font-style: italic; color: #888; }
        .sheet-container { background-color: var(--bg-color); width: 100%; max-width: 950px; padding: 40px; box-shadow: 0 0 15px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 20px; margin: 0 auto; }
        input[type="text"], input[type="number"], textarea { background: transparent; border: none; border-bottom: 1px solid var(--border-color); width: 100%; font-family: inherit; font-size: 1rem; color: var(--text-color); }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
        textarea { resize: vertical; border: 1px solid var(--faint-line); padding: 5px; }
        .label-sm { font-size: 0.7rem; text-transform: uppercase; color: #666; font-family: sans-serif; display: block; margin-top: 2px;}
        .main-header { display: grid; grid-template-columns: 2.5fr 1fr 1fr 1fr; gap: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 20px; }
        .header-section { display: flex; flex-direction: column; justify-content: flex-end; }
        .main-grid { display: grid; grid-template-columns: 1fr 2.6fr; gap: 25px; }
        .stats-col { display: flex; flex-direction: column; gap: 15px; }
        .save-val-input, .ability-mod { color: var(--text-color); }
        .ability-box {
            border: none;
            background: transparent;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .ability-visual-container {
            position: relative;
            width: 90px;
            height: 75px; /* Compressed height */
            margin-bottom: 5px;
            display: flex;
            justify-content: center;
        }

        /* Thorny Vine Filigree */
        .ability-visual-container::before {
            content: "";
            position: absolute;
            top: -5px;
            left: -10px;
            right: -10px;
            bottom: -5px;
            /* SVG of intertwined thorny vines */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 140 100'%3E%3Cstyle%3E.v%7Bfill:none;stroke:%232d3d23;stroke-width:1.5;stroke-linecap:round;%7D.v2%7Bfill:none;stroke:%233a4d2f;stroke-width:0.8;stroke-opacity:0.6;%7D.t%7Bfill:%231a2614;%7D%3C/style%3E%3Cg%3E%3C!-- Left --%3E%3Cpath class='v' d='M15,90 C5,70 2,45 10,30 C15,20 8,10 22,2'/%3E%3Cpath class='v' d='M10,85 C-2,65 5,40 15,35'/%3E%3Cpath class='v2' d='M18,80 C10,60 12,45 20,40 M5,70 C0,50 8,30 18,25 M12,45 Q25,45 22,60'/%3E%3Cpath class='t' d='M8,55 L2,53 L8,48 Z M5,35 L0,32 L6,28 Z M10,15 L5,10 L12,12 Z M20,40 L25,43 L21,48 Z M3,75 L-1,72 L4,68 Z M18,20 L14,15 L20,16 Z'/%3E%3C/g%3E%3Cg%3E%3C!-- Right --%3E%3Cpath class='v' d='M125,90 C135,70 138,45 130,30 C125,20 132,10 118,2'/%3E%3Cpath class='v' d='M130,85 C142,65 135,40 125,35'/%3E%3Cpath class='v2' d='M122,80 C130,60 128,45 120,40 M135,70 C140,50 132,30 122,25 M128,45 Q115,45 118,60'/%3E%3Cpath class='t' d='M132,55 L138,53 L132,48 Z M135,35 L140,32 L134,28 Z M130,15 L135,10 L128,12 Z M120,40 L115,43 L119,48 Z M137,75 L141,72 L136,68 Z M122,20 L126,15 L120,16 Z'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: contain;
            pointer-events: none;
            opacity: 0.5;
            z-index: 0;
        }

        .ability-mod {
            font-size: 2rem; /* Slightly smaller for compression */
            font-weight: bold;
            text-align: center;
            width: 65px; /* Slightly smaller circle */
            height: 65px;
            border: 2.5px solid var(--border-color);
            border-radius: 50%;
            background: #fff;
            position: absolute;
            top: 0;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.15);
        }

        .ability-score {
            font-size: 0.95rem;
            font-weight: bold;
            width: 40px;
            height: 24px;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-color) !important;
            position: absolute;
            bottom: 2px; /* Tucked closer to the circle */
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .skills-list {
            margin-top: 0px; /* Bring skills up closer to the score pill */
        }
        .save-val-input {  width: 30px !important; /* Slightly wider for "+2" */ text-align: center;  font-size: 0.9rem;  border-bottom: 1px solid #999 !important;  font-family: inherit; }
        .skill-row { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; border-bottom: 1px solid #eee; }
        .prof-bubble { width: 12px; height: 12px; border: 1px solid black; border-radius: 50%; appearance: none; cursor: pointer; flex-shrink: 0; }
        .prof-bubble:checked { background: black; }
        .combat-row-1 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .combat-row-2 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .shield-box { border: 2px double var(--border-color); padding: 5px; text-align: center; border-radius: 5px 5px 50% 50%; display: flex; flex-direction: column; justify-content: center; }
        .rect-box { border: 2px double var(--border-color); padding: 5px; border-radius: 5px; display: flex; flex-direction: column; }
        .box-title { font-family: sans-serif; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; text-align: center; margin-bottom: 2px;}
        .death-save-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; margin-top: 5px; }
        .ds-bubbles { display: flex; gap: 5px; }
        .physical-traits-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 5px; }
        .trait-item { text-align: center; }
        /* Drag and Drop Styles */
        .drag-handle {
            background: #5c4b3f;
            color: #fdf6e3;
            border: none;
            border-radius: 3px;
            width: 18px;
            height: 18px;
            cursor: grab;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .drag-handle:active { cursor: grabbing; }
        .drag-handle:hover { opacity: 1; }
        .dragging { opacity: 0.5; background: #dcd6c7; }
        .action-cell { display: flex; gap: 4px; align-items: center; justify-content: center; }
        .weapons-table, .spells-list-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .weapons-table th, .spells-list-table th { text-align: left; border-bottom: 2px solid var(--border-color); font-size: 0.8rem; }
        .weapons-table td, .spells-list-table td { border-bottom: 1px solid var(--faint-line); padding: 5px 0; }
        #magic-items-body input[type="checkbox"] { margin: 0 auto; display: block; cursor: pointer; }
        .equipment-table { width: 100%; border-collapse: collapse; }
        .equipment-table th { font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid var(--border-color); }
        .equipment-table td { padding: 2px 0; border-bottom: 1px solid var(--faint-line); }
        .remove-btn { background: #a39081; /* Subtle brownish-grey */ color: #fdf6e3; border: none; border-radius: 3px; width: 18px; height: 18px; cursor: pointer; font-weight: bold; font-size: 14px; line-height: 1; padding: 0; margin-left: 5px; display: flex; align-items: center; justify-content: center; opacity: 0.6; transition: all 0.2s ease; }
        .remove-btn:hover { background: #800; opacity: 1; }
        .action-cell { width: 45px; text-align: center; border-bottom: none !important; }
        .bottom-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .panel { border: 2px solid var(--border-color); border-radius: 5px; padding: 10px; }
        .panel, .class-input-wrapper { position: relative; }
        .ghost-container { position: relative; width: 100%; display: flex; }
        .ghost-mirror { position: absolute; top: 0; left: 0; width: 100%; height: 100%; color: transparent; pointer-events: none; white-space: pre-wrap; user-select: none; word-wrap: break-word; overflow: hidden; background: transparent; }
        .ghost-mirror span.highlight { border-bottom: 2px dotted #800; pointer-events: auto; cursor: help; }
        .ghost-mirror span.suggestion { color: #aaa; }
        .ghost-input { background: transparent !important; position: relative; z-index: 2; }
        .prof-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem; margin-bottom: 10px; }
        .prof-check-row { display: flex; gap: 10px; align-items: center; }
        .inner-section { display: grid; gap: 20px; margin-top: 20px; border-top: 3px double var(--border-color); padding-top: 20px; }
        .spell-header { display: grid; grid-template-columns: 2fr 3fr; gap: 15px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .spell-stats-box { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .spell-stat-item { border: 1px solid var(--border-color); border-radius: 5px; padding: 5px; text-align: center; }
        .spell-slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px 5px; font-size: 0.8rem; white-space: nowrap; }
        .diamond-check { appearance: none; width: 12px; height: 12px; border: 1px solid black; transform: rotate(45deg); margin: 2px 3px; cursor: pointer; display: inline-block; vertical-align: middle; }
        .diamond-check:checked { background: black; }
        .bio-col { display: flex; flex-direction: column; gap: 15px; height: 100%; }
        .coins-container { border: 2px solid var(--border-color); padding: 5px; border-radius: 10px; display: flex; flex-direction: column; }
        .coins { display: flex; gap: 5px; justify-content: space-around; }
        .coin-slot input { width: 40px; text-align: center; }
        #main-nav { display: flex; position: sticky; justify-content: center; background: #111; padding: 10px; gap: 10px; top: 43.5px; z-index: 100; border-bottom: 2px solid var(--border-color); width: 100%; }
        #tabs-wrapper { display: flex; flex-direction: column; width: 100%; overflow-x: auto; overflow-y: visible; scroll-snap-type: y mandatory; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        #tabs-wrapper::-webkit-scrollbar { display: none; }
        .tab-btn { background: #444; color: #eee; border: 1px solid var(--border-color); padding: 10px 15px; cursor: pointer; font-family: 'Georgia', serif; font-size: 0.9rem; border-radius: 5px; transition: 0.2s; }
        .tab-btn.active { background: var(--bg-color); color: var(--text-color); font-weight: bold; box-shadow: 0 -2px 0 var(--border-color) inset; }
        .tab-content { display: block; width: 100%; flex-direction: column; align-items: center; scroll-snap-align: start; scroll-margin-top: 80px; }
        .tab-content.active { display: flex; }

        @media screen and (max-width: 768px) {
            #main-nav { padding: 5px; gap: 5px; }
            .tab-btn { padding: 8px 5px; font-size: 0.75rem; flex: 1; }
            body { display: block; padding: 0; }
            #app-controls { flex-wrap: nowrap; overflow: hidden; max-height: 45px; transition: max-height 0.3s ease; }
            #app-controls.expanded { max-height: 500px; flex-wrap: wrap; }
            #app-controls .app-btn { display: none; }
            #app-controls.expanded .app-btn { display: inline-block; }
            #status, #auth-btn, #app-toggle-hamburger { display: inline-block; }
            #app-controls button { padding: 3px 5px; font-size: 0.75rem; }
            .sheet-container { margin-top: 0; padding: 10px; padding-top: 20px; border-radius: 0; box-shadow: none; }
            .main-grid, .inner-section, .main-header, .combat-row-1, .combat-row-2, .spell-header, .bottom-sections, .prof-grid { display: flex; flex-direction: column; }
            #status { margin-left: 0; width: 100%; }
            #ability-scores-container { display: flex; flex-wrap: wrap;  justify-content: center; gap: 10px; width: 100%; }
            .ability-box { flex: 1 1 30%; min-width: 100px; margin-top: 10px; }
            .ability-mod { width: 55px; height: 55px; font-size: 1.5rem; }
        }
        @media print {
            #app-controls { display: none !important; }
            body { background: white; padding: 0; display: block; }
            .sheet-container { width: 100%; max-width: 100%; box-shadow: none; padding: 0; margin: 0; }
            textarea { border: 1px solid #ccc; }
        }
        @media (hover: hover) {
            input[type="number"]:hover::-webkit-outer-spin-button, input[type="number"]:hover::-webkit-inner-spin-button { -webkit-appearance: auto; }
            input[type="number"]:hover { -moz-appearance: number-input; }
        }

        /* TOOLTIP CSS */
        #ai-tooltip {
            position: fixed; background: rgba(20, 20, 20, 0.95); color: #dcd6c7; padding: 10px 15px; border-radius: 4px;
            border: 1px solid #800; font-family: 'Courier New', monospace; font-size: 0.85rem; max-width: 250px; z-index: 9999;
            pointer-events: none; opacity: 0; transition: opacity 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.5); line-height: 1.4;
        }
        #ai-tooltip strong { color: #ff5555; display: block; margin-bottom: 4px; text-transform: uppercase; font-size: 0.75rem; border-bottom: 1px solid #444; padding-bottom: 2px; }
        body.tips-enabled [data-tip] { cursor: help; border-bottom: 1px dotted #888; }
        body.tips-enabled [data-tip]:hover, body.tips-enabled [data-tip]:focus { color: #800; border-bottom: 1px solid #800; outline: none; }
        [data-tip] { outline: none; }
    </style>
</head>
<body>
    <div id="ai-tooltip"></div>

    <div id="app-controls">
        <span><b>D&D 5e</b></span>
        <button id="auth-btn">Login with Google</button>
        <div class="dropdown app-btn">
            <button onclick="toggleManagementMenu(event)" style="background: #444; cursor: pointer;">üìÅ Char Mgmt ‚ñæ</button>
            <div id="management-menu" class="dropdown-content">
                <span class="menu-group-label">Switch / Create</span>
                <select id="charSelect" onchange="loadMyCharacter()" style="width: 100%;">
                    <option value="">My Characters...</option>
                </select>
                <button onclick="resetSheet()" style="background: #800; width: 100%; text-align: left;">+ New Character</button>

                <span class="menu-group-label">Version Control</span>
                <button onclick="saveVersion(true)" style="width: 100%; text-align: left;">üíæ Save Snapshot</button>
                <select id="versionSelect" onchange="loadSelectedVersion()" style="width: 100%;">
                    <option value="">Load Version...</option>
                </select>
            </div>
        </div>
        <button class="app-btn" id="toggle-tips" onclick="toggleTips()" style="background: #222;">Tips: ON</button>
        <button class="app-btn" onclick="shortRest()" style="background: #6b46c1;">Short Rest</button>
        <button class="app-btn" onclick="longRest()" style="background: #2d3748;">Long Rest</button>
        <button class="app-btn" onclick="resetSheet()" style="background: #800;">New</button>
        <button class="app-btn" onclick="window.print()" style="background: #005f80;">Print</button>
        <button class="app-btn" onclick="shareSheet()" style="background: #28a745;">Share URL</button>
        <span id="status" style="font-size: 0.8rem; color: #aaa; margin-left: auto;">Offline Mode</span>
        <button id="app-toggle-hamburger">‚ò∞</button>
    </div>

    <nav id="main-nav">
        <button class="tab-btn active" onclick="switchTab('main-page')">Character</button>
        <button class="tab-btn" onclick="switchTab('spells-page')">Spells</button>
        <button class="tab-btn" onclick="switchTab('equip-page')">Equipment</button>
        <button class="tab-btn class-specific class-artificer hidden-class-feature" onclick="switchTab('items-page')">Item Plans</button>
        <button class="tab-btn class-specific class-druid hidden-class-feature" onclick="switchTab('wild-shape-page')">Wild Shape</button>
        <button class="tab-btn class-specific class-warlock hidden-class-feature" onclick="switchTab('invocations-page')">Invocations</button>
        <button class="tab-btn" onclick="switchTab('story-page')">Backstory</button>
        <button class="tab-btn" onclick="switchTab('notes-page')">Notes</button>
        <button class="tab-btn" onclick="switchTab('people-page')">People</button>
    </nav>

    <div id="tabs-wrapper">
    <div id="main-page" class="tab-content active" data-label="Character Sheet">
    <div class="sheet-container">
        <div class="main-header">
            <div class="header-section">
                <input type="text" id="charName" placeholder="Character Name" style="font-size: 1.5rem; font-weight: bold;">
                <span class="label-sm" data-tip="Character Name" tabindex="0">Character Name</span>
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <div style="flex: 1;"><input type="text" id="species" placeholder="Species"><span class="label-sm" data-tip="Species" tabindex="0">Species</span></div>
                    <div style="flex: 1;"><input type="text" id="background" placeholder="Background"><span class="label-sm" data-tip="Background" tabindex="0">Background</span></div>
                </div>
            </div>
            <div class="header-section">
                <div class="class-input-wrapper">
                    <input type="text" id="class"><span class="label-sm" data-tip="Class" tabindex="0">Class</span>
                    <input type="text" id="subclass"><span class="label-sm" data-tip="Subclass" tabindex="0">Subclass</span>
                    <span id="class-input-badge" class="class-badge"></span>
                </div>
            </div>
            <div class="header-section">
                <input type="text" id="level"><span class="label-sm" data-tip="Level" tabindex="0">Level</span>
                <input type="text" id="xp"><span class="label-sm" data-tip="XP" tabindex="0">XP</span>
            </div>
            <div class="header-section">
                <div id="portrait-container" onclick="this.classList.toggle('editing')">
                    <div id="portrait-placeholder">Click to add Portrait URL</div>
                    <img id="char-portrait" src="" alt="Portrait" style="display:none;">
                </div>

                <div id="portrait-url-container">
                    <label style="font-size: 0.6rem; text-transform: uppercase; color: #666;">Image URL:</label>
                    <input type="text" id="portrait-url" placeholder="Paste URL here..."
                           style="width: 100%; font-size: 0.75rem; padding: 4px;">
                </div>
            </div>
        </div>
        <div class="main-grid">
            <div class="stats-col">
                <div id="ability-scores-container"></div>
            </div>

            <div class="main-col">
                <div class="combat-row-1">
                    <div class="shield-box"><span class="box-title" data-tip="Proficiency" tabindex="0">Prof. Bonus</span><input type="text" id="prof-bonus" style="text-align: center; font-size: 1rem;"></div>
                    <div class="shield-box"><span class="box-title" data-tip="AC" tabindex="0">AC</span><input type="number" id="ac" style="text-align: center; font-size: 1rem;"></div>
                    <div class="shield-box"><span class="box-title" data-tip="Initiative" tabindex="0">Initiative</span><input type="text" id="initiative" placeholder="d20 + dex mod" style="text-align: center; font-size: 1rem;"></div>
                    <div class="shield-box"><span class="box-title" data-tip="Speed" tabindex="0">Speed</span><input type="text" id="speed" style="text-align: center; font-size: 1rem;"></div>
                    <div class="shield-box"><span class="box-title" data-tip="Size" tabindex="0">Size</span><input type="text" id="size" style="text-align: center; font-size: 1rem;"></div>
                    <div class="shield-box"><span class="box-title" data-tip="Passive Perception" tabindex="0">Passive Perc.</span><input type="text" id="pass-perc" style="text-align: center; font-size: 1rem;"></div>
                </div>

                <div class="combat-row-2">
                    <div class="rect-box">
                        <span class="box-title" data-tip="Hit Points" tabindex="0">Hit Points</span>
                        <div style="display: flex; gap: 10px; height: 100%;">
                            <div style="flex:1; text-align: center;"><input type="number" id="hp-max" placeholder="Max" style="text-align:center;"><span class="label-sm">Max</span></div>
                            <div style="flex:1; text-align: center;"><input type="number" id="hp-curr" placeholder="Current" style="text-align:center; font-size: 1.2rem; font-weight: bold;"><span class="label-sm">Current</span></div>
                            <div style="flex:1; text-align: center;"><input type="number" id="hp-temp" placeholder="Temp" style="text-align:center;"><span class="label-sm">Temp</span></div>
                        </div>
                    </div>
                    <div class="rect-box">
                        <span class="box-title" data-tip="Death Saves" tabindex="0">Death Saves</span>
                        <div class="death-save-row"><span data-tip="Successes" tabindex="0">Successes</span><div class="ds-bubbles"><input type="checkbox" class="prof-bubble" id="ds-s-1"><input type="checkbox" class="prof-bubble" id="ds-s-2"><input type="checkbox" class="prof-bubble" id="ds-s-3"></div></div>
                        <div class="death-save-row"><span data-tip="Failures" tabindex="0">Failures</span><div class="ds-bubbles"><input type="checkbox" class="prof-bubble" id="ds-f-1"><input type="checkbox" class="prof-bubble" id="ds-f-2"><input type="checkbox" class="prof-bubble" id="ds-f-3"></div></div>
                    </div>
                    <div id="class-features-container">
                        <div class="rect-box class-specific class-barbarian hidden-class-feature class-input-wrapper">
                            <span class="class-badge" title="Barbarian">ü™ì</span>
                            <span class="box-title">Barbarian</span>
                            <div class="counter-row">
                                <span class="counter-label">Rages</span>
                                <div class="ds-bubbles">
                                    <input type="checkbox" class="prof-bubble" id="rage-1"><input type="checkbox" class="prof-bubble" id="rage-2">
                                    <input type="checkbox" class="prof-bubble" id="rage-3"><input type="checkbox" class="prof-bubble" id="rage-4">
                                    <input type="checkbox" class="prof-bubble" id="rage-5"><input type="checkbox" class="prof-bubble" id="rage-6">
                                </div>
                            </div>
                        </div>

                        <div class="rect-box class-specific class-bard hidden-class-feature class-input-wrapper">
                            <span class="class-badge" title="Bard">üéª</span>
                            <span class="box-title">Bardic Inspiration</span>
                            <div class="counter-row">
                                <span class="counter-label">Die Size</span>
                                <input type="text" id="bardic-die" placeholder="d6" style="width: 50px; text-align: center;">
                            </div>
                            <div class="counter-row">
                                <span class="counter-label">Uses</span>
                                <div class="ds-bubbles">
                                    <input type="checkbox" class="prof-bubble" id="bard-1"><input type="checkbox" class="prof-bubble" id="bard-2">
                                    <input type="checkbox" class="prof-bubble" id="bard-3"><input type="checkbox" class="prof-bubble" id="bard-4"><input type="checkbox" class="prof-bubble" id="bard-5">
                                </div>
                            </div>
                        </div>

                        <div class="rect-box class-specific class-cleric class-paladin hidden-class-feature class-input-wrapper">
                            <span class="class-badge" title="Cleric/Paladin">üîØ</span>
                            <span class="box-title">Channel Divinity</span>
                            <div class="counter-row">
                                <span class="counter-label">Uses</span>
                                <div class="ds-bubbles">
                                    <input type="checkbox" class="prof-bubble" id="channel-divinity-1">
                                    <input type="checkbox" class="prof-bubble" id="channel-divinity-2">
                                    <input type="checkbox" class="prof-bubble" id="channel-divinity-3">
                                </div>
                            </div>
                        </div>

                        <div class="rect-box class-specific class-fighter hidden-class-feature class-input-wrapper">
                            <span class="class-badge" title="Fighter">‚öîÔ∏è</span>
                            <span class="box-title">Fighter Features</span>
                            <div class="counter-row">
                                <span class="counter-label">Second Wind</span>
                                <div class="ds-bubbles">
                                    <input type="checkbox" class="prof-bubble" id="second-wind-1">
                                    <input type="checkbox" class="prof-bubble" id="second-wind-2">
                                </div>
                            </div>
                             <div style="margin-top:10px;">
                                <span class="counter-label">Weapon Mastery</span>
                                <textarea id="weapon-mastery" style="height: 40px; border: 1px solid var(--faint-line);"></textarea>
                            </div>
                        </div>

                        <div class="rect-box class-specific class-monk hidden-class-feature class-input-wrapper">
                            <span class="class-badge" title="Monk">üßò</span>
                            <span class="box-title">Ki / Focus Points</span>
                            <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                                <div style="flex:1; text-align: center;"><input type="number" id="ki-curr" placeholder="Curr" style="text-align:center;"><span class="label-sm">Current</span></div>
                                <div style="flex:1; text-align: center;"><input type="number" id="ki-max" placeholder="Max" style="text-align:center;"><span class="label-sm">Max</span></div>
                            </div>
                            <div class="counter-row">
                                <span class="counter-label">Unarmored Mvmt</span>
                                <input type="text" id="unarmored-mvmt" placeholder="+10 ft" style="width: 60px; text-align: center;">
                            </div>
                            <div class="counter-row">
                                <span class="counter-label">Martial Arts Die</span>
                                <input type="text" id="martial-arts-die" placeholder="1d4" style="width: 60px; text-align: center;">
                            </div>
                        </div>

                        <div class="rect-box class-specific class-ranger hidden-class-feature class-input-wrapper">
                            <span class="class-badge" title="Ranger">üèπ</span>
                            <span class="box-title">Ranger</span>
                            <span class="counter-label">Favored Enemy / Foe</span>
                            <textarea id="favored-enemy" style="height: 60px; border: 1px solid var(--faint-line);"></textarea>
                        </div>

                        <div class="rect-box class-specific class-rogue hidden-class-feature class-input-wrapper">
                            <span class="class-badge" title="Rogue">üó°Ô∏è</span>
                            <span class="box-title">Rogue</span>
                            <div class="counter-row">
                                <span class="counter-label">Sneak Attack Dmg</span>
                                <input type="text" id="sneak-attack" placeholder="1d6" style="width: 80px; text-align: center;">
                            </div>
                        </div>

                        <div class="rect-box class-specific class-sorcerer hidden-class-feature class-input-wrapper">
                            <span class="class-badge" title="Sorcerer">üîÆ</span>
                            <span class="box-title">Sorcery Points</span>
                            <div style="display: flex; gap: 10px;">
                                <div style="flex:1; text-align: center;"><input type="number" id="sorc-curr" placeholder="Curr" style="text-align:center;"><span class="label-sm">Current</span></div>
                                <div style="flex:1; text-align: center;"><input type="number" id="sorc-max" placeholder="Max" style="text-align:center;"><span class="label-sm">Max</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="margin-bottom: 15px;">
                    <span class="box-title" tabindex="0">Physical Characteristics</span>
                    <div class="physical-traits-grid">
                        <div class="trait-item"><input type="text" id="age" placeholder="25"><span class="label-sm">Age</span></div>
                        <div class="trait-item"><input type="text" id="height" placeholder="5'10"><span class="label-sm">Height</span></div>
                        <div class="trait-item"><input type="text" id="weight" placeholder="160 lbs"><span class="label-sm">Weight</span></div>
                    </div>
                    <div class="physical-traits-grid">
                        <div class="trait-item"><input type="text" id="eyes" placeholder="Blue"><span class="label-sm">Eyes</span></div>
                        <div class="trait-item"><input type="text" id="skin" placeholder="Fair"><span class="label-sm">Skin</span></div>
                        <div class="trait-item"><input type="text" id="hair" placeholder="Brown"><span class="label-sm">Hair</span></div>
                    </div>
                </div>

                <div class="panel">
                    <span class="box-title" data-tip="Weapons" tabindex="0">Weapons & Damage Cantrips</span>
                    <table class="weapons-table">
                        <thead><tr><th>Name</th><th data-tip="Atk/DC" tabindex="0">Atk/DC</th><th data-tip="Damage" tabindex="0">Damage</th><th>Notes</th><th class="action-cell"></th></tr></thead>
                        <tbody id="weapons-body"></tbody>
                    </table>
                    <button onclick="addWeaponRow()" style="width: 100%;">+</button>
                </div>

                <div class="panel" style="margin-top: 10px;">
                    <span class="box-title" data-tip="Proficiencies" tabindex="0">Proficiencies & Languages</span>
                    <div style="margin-bottom: 5px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                        <span class="label-sm" style="display:inline; margin-right: 10px;">Armor:</span>
                        <label><input type="checkbox" id="prof-armor-light"> Light</label> &nbsp;
                        <label><input type="checkbox" id="prof-armor-medium"> Medium</label> &nbsp;
                        <label><input type="checkbox" id="prof-armor-heavy"> Heavy</label> &nbsp; | &nbsp;
                        <label><input type="checkbox" id="prof-shields"> Shields</label>
                    </div>
                    <div style="margin-bottom: 5px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                        <span class="label-sm" style="display:inline; margin-right: 10px;">Weapon:</span>
                        <label><input type="checkbox" id="prof-weapon-simple"> Simple</label> &nbsp;
                        <label><input type="checkbox" id="prof-weapon-martial"> Martial</label>
                    </div>
                    <div class="prof-grid">
                        <div><span class="label-sm">Tools</span><textarea id="prof-tools-text" style="height: 120px;"></textarea></div>
                        <div><span class="label-sm" data-tip="Languages">Languages</span><textarea id="languages" style="height: 120px;"></textarea></div>
                    </div>
                </div>

                <div class="bottom-sections">
                    <div class="panel"><span class="box-title" data-tip="Class Features" tabindex="0">Class Features</span><textarea id="class-features" style="height: 120px; border:none;"></textarea></div>
                    <div class="panel"><span class="box-title" data-tip="Background Features" tabindex="0">Background Features</span><textarea id="background-features" style="height: 120px; border:none;"></textarea></div>
                </div>

                <div class="bottom-sections">
                    <div class="panel"><span class="box-title" data-tip="Species Traits" tabindex="0">Species Traits</span><textarea id="species-traits" style="height: 140px; border:none;"></textarea></div>
                    <div class="panel"><span class="box-title" data-tip="Feats" tabindex="0">Feats</span><textarea id="feats" style="height: 140px; border:none;"></textarea></div>
                </div>

                <div class="bottom-sections">
                    <div class="panel"><span class="box-title" data-tip="Appearance" tabindex="0">Appearance</span><textarea id="appearance" style="height: 320px; border:none;"></textarea></div>
                    <div class="panel" style="display: flex; flex-direction: column;">
                        <span class="box-title" data-tip="Backstory" tabindex="0">Personality</span>
                        <textarea id="personality" style="height: 280px; flex-grow: 1; border:none;"></textarea>
                        <div style="margin-top: 5px; border-top: 1px solid #ccc; padding-top: 5px;">
                            <span class="label-sm" style="display:inline;" data-tip="Alignment" tabindex="0">Alignment:</span><input type="text" id="alignment" style="width: 70%; display:inline-block;">
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    </div>
    <div id="spells-page" class="tab-content" data-label="Spellbook">
    <div class="sheet-container">
        <div class="inner-section">
            <div>
                <div class="spell-header">
                    <div class="panel">
                        <span class="box-title" style="margin-bottom: 10px; display:block;" data-tip="Spellcasting" tabindex="0">Spellcasting</span>
                        <div class="spell-stats-box">
                            <div class="spell-stat-item"><span class="label-sm" data-tip="Spell Ability" tabindex="0">Ability</span><select id="spell-ability" style="width: 100%; background: transparent; border: none; border-bottom: 1px solid var(--border-color); text-align: center; font-family: inherit;"><option value="">None</option><option value="strength">Str</option><option value="dexterity">Dex</option><option value="constitution">Con</option><option value="intelligence">Int</option><option value="wisdom">Wis</option><option value="charisma">Cha</option></select></div>
                            <div class="spell-stat-item"><span class="label-sm" data-tip="Spell Mod" tabindex="0">Modifier</span><input type="text" id="spell-mod" style="text-align:center;"></div>
                            <div class="spell-stat-item"><span class="label-sm" data-tip="Other Mod Explanation" tabindex="0">Other Mod.</span><input type="text" id="other-mod-explanation" style="text-align:center;"></div>
                            <div class="spell-stat-item"><span class="label-sm" data-tip="Save DC" tabindex="0">Save DC</span><input type="text" id="spell-save-dc" style="text-align:center;"></div>
                            <div class="spell-stat-item"><span class="label-sm" data-tip="Spell Atk" tabindex="0">Atk Bonus</span><input type="text" id="spell-atk" style="text-align:center;"></div>
                            <div class="spell-stat-item"><span class="label-sm" data-tip="Other Mod" tabindex="0">Other Mod.</span><input type="number" id="other-mod" style="text-align:center;"></div>
                        </div>
                    </div>
                    <div class="panel">
                        <span class="box-title" data-tip="Spell Slots" tabindex="0">Spell Slots</span>
                        <div class="spell-slots-grid" id="spell-slots-container"></div>
                    </div>
                </div>

                <div class="panel">
                    <span class="box-title" data-tip="Cantrips" tabindex="0">Cantrips & Prepared Spells</span>
                    <table class="spells-list-table">
                        <thead>
                            <tr>
                                <th width="45px">Lvl</th>
                                <th>Name</th>
                                <th width="120" style="text-align: center;">
                                    <span title="Verbal" data-tip="Verbal" tabindex="0">V</span> / <span title="Somatic" data-tip="Somatic" tabindex="0">S</span> / <span title="Concentration" data-tip="Concentration" tabindex="0">C</span> / <span title="Ritual" data-tip="Ritual" tabindex="0">R</span> / <span title="Material" data-tip="Material" tabindex="0">M</span>
                                <th class="action-cell"></th>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="spells-body"></tbody>
                    </table>
                    <button onclick="addSpellRow()" style="width: 100%;">+</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div id="equip-page" class="tab-content" data-label="Equipment">
    <div class="sheet-container">
        <div class="inner-section">
            <div class="panel">
                <span class="box-title" data-tip="Equipment">Equipment</span>
                <table class="equipment-table">
                    <thead>
                        <tr>
                            <th style="width: 45%">Item</th>
                            <th style="width: 15%">Qty</th>
                            <th style="width: 15%">Lbs</th>
                            <th style="width: 25%">Notes</th>
                            <th class="action-cell"></th>
                        </tr>
                    </thead>
                    <tbody id="equipment-body"></tbody>
                </table>
                <button onclick="addEquipmentRow()" style="width: 100%;">+</button>
                <div style="text-align: right; margin-top: 10px; font-weight: bold; border-top: 1px solid var(--border-color);">
                    Total Weight: <span id="total-weight">0</span> lbs
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; ">
                <div></div>
                <div class="coins-container">
                    <span class="box-title" data-tip="Coins" tabindex="0">COINS</span>
                    <div class="coins">
                        <div class="coin-slot"><span class="label-sm" data-tip="CP" tabindex="0">CP</span><input type="number" id="cp"></div>
                        <div class="coin-slot"><span class="label-sm" data-tip="SP" tabindex="0">SP</span><input type="number" id="sp"></div>
                        <div class="coin-slot"><span class="label-sm" data-tip="EP" tabindex="0">EP</span><input type="number" id="ep"></div>
                        <div class="coin-slot"><span class="label-sm" data-tip="GP" tabindex="0">GP</span><input type="number" id="gp"></div>
                        <div class="coin-slot"><span class="label-sm" data-tip="PP" tabindex="0">PP</span><input type="number" id="pp"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div id="items-page" class="tab-content class-specific class-artificer hidden-class-feature" data-label="Item Plans">
    <div class="sheet-container">
        <div class="inner-section">
            <div class="panel">
                <span class="class-badge">‚öôÔ∏è</span>
                <span class="box-title" data-tip="Magic Item Plans">Magic Item Plans</span>
                <table class="weapons-table">
                    <thead>
                        <tr>
                            <th style="width: 30px; text-align: center;">Made</th>
                            <th>Item Name</th>
                            <th style="width: 100px; text-align: center;">Attun.</th>
                            <th>Notes</th>
                            <th class="action-cell"></th>
                        </tr>
                    </thead>
                    <tbody id="magic-items-body"></tbody>
                </table>
                <button onclick="addMagicItemRow()" style="width: 100%;">+</button>
            </div>
        </div>
    </div>
    </div>
    <div id="wild-shape-page" class="tab-content class-specific class-druid hidden-class-feature" data-label="Wild Shape">
    <div class="sheet-container">
        <div class="inner-section">
            <div class="panel">
                <span class="class-badge">üåø</span>
                <span class="box-title">Wild Shapes</span>
                <table class="weapons-table">
                    <thead>
                        <tr>
                            <th>Beast Name</th>
                            <th style="width: 50px">CR</th>
                            <th style="width: 50px">HP</th>
                            <th style="width: 50px">AC</th>
                            <th style="width: 50px">Spd</th>
                            <th>Attacks/Notes</th>
                            <th class="action-cell"></th>
                        </tr>
                    </thead>
                    <tbody id="wild-shape-body"></tbody>
                </table>
                <button onclick="addWildShapeRow()" style="width: 100%;">+</button>
            </div>
        </div>
    </div>
    </div>
    <div id="invocations-page" class="tab-content class-specific class-warlock hidden-class-feature" data-label="Invocations">
    <div class="sheet-container">
        <div class="inner-section">
            <div class="panel">
                <span class="class-badge">üëÅÔ∏è</span>
                <span class="box-title">Eldritch Invocations</span>
                <table class="weapons-table">
                    <thead>
                        <tr>
                            <th>Invocation Name</th>
                            <th>Description / Effect</th>
                            <th class="action-cell"></th>
                        </tr>
                    </thead>
                    <tbody id="invocations-body"></tbody>
                </table>
                <button onclick="addInvocationRow()" style="width: 100%;">+</button>
            </div>
             <div class="panel" style="margin-top: 20px;">
                <span class="box-title">Pact Boon</span>
                <textarea id="pact-boon" style="height: 100px; border: none;"></textarea>
            </div>
        </div>
    </div>
    </div>
    <div id="story-page" class="tab-content" data-label="Backstory">
    <div class="sheet-container">
        <div class="inner-section">
            <div class="panel">
                <span class="box-title" data-tip="Backstory">Backstory</span>
                <textarea id="backstory" style="min-height: 60vh; flex-grow: 1; border:none;"></textarea>
            </div>
        </div>
    </div>
    </div>
    <div id="notes-page" class="tab-content" data-label="Notes">
    <div class="sheet-container">
        <div class="inner-section">
            <div class="panel">
                <span class="box-title" data-tip="Notes">Notes</span>
                <textarea id="notes" style="min-height: 60vh; flex-grow: 1; border:none;"></textarea>
            </div>
        </div>
    </div>
    </div>
    <div id="people-page" class="tab-content" data-label="People">
    <div class="sheet-container">
        <div class="inner-section">
            <div class="panel">
                <span class="box-title">People</span>
                <table class="people-table">
                    <thead>
                        <tr>
                            <th style="width: 20%">Name</th>
                            <th style="width: 15%">Desc.</th>
                            <th style="width: 65%">Notes</th>
                            <th class="action-cell"></th>
                        </tr>
                    </thead>
                    <tbody id="people-body"></tbody>
                </table>
                <button onclick="addPeopleRow()" style="width: 100%;">+</button>
            </div>
        </div>
    </div>
    </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, query, where, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIG ---
        let tipsEnabled = true;
        let AI_COMMENTS = {};

        const firebaseConfig = {
          apiKey: "AIzaSyAMfAkyUevv3BDKSO3yBjRra3jZ_uV5OlA",
          authDomain: "dnd-character-sheet-5e.firebaseapp.com",
          projectId: "dnd-character-sheet-5e",
          storageBucket: "dnd-character-sheet-5e.firebasestorage.app",
          messagingSenderId: "554732035132",
          appId: "1:554732035132:web:ed89be7af2ceea147a7739"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // --- STATE ---
        let currentUser = null;
        let currentCharacterId = localStorage.getItem('dnd_char_id') || generateUUID();
        let isCloudOwner = true;
        let isLoading = false;
        let isAppReady = false;
        const suggestLoadRemoteChanges = false;
        let lastLoadedRemoteTimestamp = 0;
        let lastLocalChangeTimestamp = 0;
        let lastAutoSnapshotTime = 0;

        const appControls = document.getElementById('app-controls');
        const toggleHandle = document.getElementById('app-toggle-hamburger');
        toggleHandle.addEventListener('click', (e) => { e.stopPropagation(); appControls.classList.toggle('expanded'); });
        function updateMobileToggle() { toggleHandle.style.display = (window.innerWidth <= 768) ? 'inline-block' : 'none'; }
        updateMobileToggle(); window.addEventListener('resize', updateMobileToggle);
        localStorage.setItem('dnd_char_id', currentCharacterId);

        window.login = async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert("Login failed: " + e.message); } };
        window.logout = () => { signOut(auth); window.location.reload(); };

        onAuthStateChanged(auth, async (user) => {
            const authBtn = document.getElementById('auth-btn');
            const statusEl = document.getElementById('status');
            if (user) {
                currentUser = user;
                authBtn.innerText = `Logout (${user.displayName.split(' ')[0]})`;
                authBtn.onclick = window.logout;
                statusEl.innerText = "Online";
                await updateMyCharactersList();
                await setupRealtimeListener();
            } else {
                currentUser = null;
                authBtn.innerText = "Login with Google";
                authBtn.onclick = window.login;
                statusEl.innerText = "Offline Mode";
            }
        });

        async function updateMyCharactersList() {
            if(!currentUser) return;
            const select = document.getElementById('charSelect');
            try {
                const q = query(collection(db, "characters"), where("ownerId", "==", currentUser.uid));
                const snap = await getDocs(q);
                select.innerHTML = '<option value="">My Characters...</option>';
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const opt = document.createElement('option');
                    opt.value = docSnap.id;
                    opt.text = d.sheetData?.charName || "Unnamed";
                    select.appendChild(opt);
                });
                const newOpt = document.createElement('option'); newOpt.value = "NEW"; newOpt.text = "+ Create New Character"; select.appendChild(newOpt);
            } catch(e) { console.error("Error listing characters", e); }
        }

        window.loadMyCharacter = async function() {
            const select = document.getElementById('charSelect');
            if(!select.value) return;
            if(select.value === "NEW") { window.resetSheet(); return; }
            currentCharacterId = select.value;
            localStorage.setItem('dnd_char_id', currentCharacterId);
            window.location.href = `${window.location.pathname}?charId=${select.value}`;
        }

        function setupRealtimeListener() {
            if (!currentUser || !currentCharacterId) return;

            // Main character document listener
            onSnapshot(doc(db, "characters", currentCharacterId), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    isCloudOwner = (currentUser.uid === data.ownerId);
                    document.getElementById('status').innerText = isCloudOwner ? "Online (Owner)" : "Online (Read Only)";

                    // Convert ISO string back to number for comparison logic
                    const cloudTime = data.lastUpdated ? new Date(data.lastUpdated).getTime() : 0;

                    if (suggestLoadRemoteChanges && cloudTime > lastLoadedRemoteTimestamp) {
                        if (lastLocalChangeTimestamp > lastLoadedRemoteTimestamp) {
                            if (confirm("New version available! Overwrite local edits?")) loadHeadData(data, cloudTime);
                            else lastLoadedRemoteTimestamp = Date.now();
                        } else { loadHeadData(data, cloudTime); }
                    }
                } else {
                    isCloudOwner = true;
                    document.getElementById('status').innerText = "Online (New)";
                }
            });

            // Snapshots sub-collection listener
            const snapsQ = query(collection(db, "characters", currentCharacterId, "snapshots"), orderBy("createdAt", "desc"), limit(40));
            onSnapshot(snapsQ, (qSnap) => {
                const select = document.getElementById('versionSelect');
                select.innerHTML = '<option value="">Load Version...</option>';

                qSnap.forEach(docSnap => {
                    const d = docSnap.data();
                    // Javascript's new Date() handles both ISO strings and Integers automatically
                    const dateObj = new Date(d.createdAt);
                    const dateStr = dateObj.toLocaleDateString([], { month: 'numeric', day: 'numeric' });
                    const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });

                    const opt = document.createElement('option');
                    opt.value = docSnap.id;
                    opt.text = `[${dateStr} ${timeStr}] ${d.name || 'Auto'}`;
                    select.appendChild(opt);
                });
            });
        }

        function loadHeadData(data, timestamp) {
            isLoading = true;
            isAppReady = false;
            populateData(data.sheetData);
            lastLoadedRemoteTimestamp = typeof timestamp === 'number' ? timestamp : new Date(timestamp).getTime();
            if (data.sheetData['portrait-url']) {
                updatePortraitFromURL(data.sheetData['portrait-url']);
            }
            isLoading = false;
        }

        window.saveVersion = async function(isManualSnapshot = false) {
            if (!currentUser) return alert("Login required.");
            if (!isCloudOwner) return alert("You can only save characters you own.");
            const data = collectData();
            const now = new Date();
            const nowIso = now.toISOString();
            const todayStr = now.toLocaleDateString();

            const charRef = doc(db, "characters", currentCharacterId);
            try {
                // 1. Always update the main document (Head)
                await setDoc(charRef, {
                    ownerId: currentUser.uid,
                    lastUpdated: nowIso,
                    sheetData: data
                }, { merge: true });

                lastLoadedRemoteTimestamp = now.getTime();

                // 2. Snapshot Logic
                // Only trigger if manual OR enough time passed since last distinct auto-save logic
                if (isManualSnapshot || (now.getTime() - lastAutoSnapshotTime > 5 * 60 * 1000)) {
                    const snapsCol = collection(db, "characters", currentCharacterId, "snapshots");

                    // Check the most recent snapshot
                    const recentQuery = query(snapsCol, orderBy("createdAt", "desc"), limit(1));
                    const recentSnap = await getDocs(recentQuery);

                    let shouldOverwrite = false;
                    let overwriteId = null;

                    if (!recentSnap.empty && !isManualSnapshot) {
                        const lastSnap = recentSnap.docs[0].data();
                        const lastSnapDate = new Date(lastSnap.createdAt).toLocaleDateString();

                        // If last save was Auto-Save AND it was created today
                        if (lastSnap.name === "Auto-Save" && lastSnapDate === todayStr) {
                            shouldOverwrite = true;
                            overwriteId = recentSnap.docs[0].id;
                        }
                    }

                    if (shouldOverwrite) {
                        // Overwrite the existing auto-save entry
                        await setDoc(doc(snapsCol, overwriteId), {
                            name: "Auto-Save",
                            createdAt: nowIso, // Update time to now
                            sheetData: data,
                            createdBy: currentUser.uid
                        });
                        console.log("Auto-save overwritten.");
                    } else {
                        // Create new snapshot
                        let name = "Auto-Save";
                        if (isManualSnapshot) {
                            name = prompt("Snapshot Name:", `Snapshot-${todayStr}`);
                            if (!name) return;
                        }
                        await addDoc(snapsCol, {
                            name: name,
                            createdAt: nowIso,
                            sheetData: data,
                            createdBy: currentUser.uid
                        });
                        console.log("New snapshot created.");
                    }
                    lastAutoSnapshotTime = now.getTime();
                }
                updateMyCharactersList();
            } catch (e) { console.error("Save error:", e); alert("Error saving: " + e.message); }
        };

        window.loadSelectedVersion = async function() {
            const select = document.getElementById('versionSelect');
            if(!select.value || !confirm("Load this version? Unsaved changes lost.")) return;
            isLoading = true;
            try {
                const snapDoc = await getDoc(doc(db, "characters", currentCharacterId, "snapshots", select.value));
                if(snapDoc.exists()) {
                    const d = snapDoc.data(); populateData(d.sheetData);
                    lastLoadedRemoteTimestamp = Date.now(); lastLocalChangeTimestamp = Date.now();
                    alert(`Loaded: ${d.name}`);
                }
            } catch(e) { console.error(e); } finally { isLoading = false; }
        }

        // -- PORTRAIT & UPLOAD LOGIC --
        function updatePortraitFromURL(url) {
            const img = document.getElementById('char-portrait');
            const placeholder = document.getElementById('portrait-placeholder');
            const container = document.getElementById('portrait-container');

            if (url && url.trim() !== "") {
                img.src = url;
                img.style.display = 'block';
                placeholder.style.display = 'none';
                container.classList.remove('editing');

                img.onerror = () => {
                    img.style.display = 'none';
                    placeholder.style.display = 'block';
                    placeholder.innerText = "Error loading image";
                    container.classList.add('editing');
                };

                // Update Social Media Meta Tags for Link Sharing
                const metaTags = [
                    { property: 'og:image', value: url },
                    { name: 'twitter:image', value: url },
                ];

                metaTags.forEach(tag => {
                    let el = tag.property
                        ? document.querySelector(`meta[property="${tag.property}"]`)
                        : document.querySelector(`meta[name="${tag.name}"]`);

                    if (!el) {
                        el = document.createElement('meta');
                        if (tag.property) el.setAttribute('property', tag.property);
                        if (tag.name) el.setAttribute('name', tag.name);
                        document.head.appendChild(el);
                    }
                    el.content = tag.value;
                });
            } else {
                img.style.display = 'none';
                placeholder.style.display = 'block';
                placeholder.innerText = "Click to add Portrait URL";
                container.classList.add('editing'); // Show URL input if empty
            }
        }

        // --- CLASS SPECIFIC ELEMENTS ---

        const classEmojiMap = {
            'barbarian': 'ü™ì', 'bard': 'üéª', 'cleric': 'üîØ', 'druid': 'üåø',
            'fighter': '‚öîÔ∏è', 'monk': 'üßò', 'paladin': 'üîØ', 'ranger': 'üèπ',
            'rogue': 'üó°Ô∏è', 'sorcerer': 'üîÆ', 'warlock': 'üëÅÔ∏è', 'artificer': '‚öôÔ∏è'
        };

        window.updateClassFeatures = function() {
            const clsInput = document.getElementById('class').value || "";
            const clsNormal = clsInput.toLowerCase();
            const inputBadge = document.getElementById('class-input-badge');

            // Reset input badge
            inputBadge.textContent = '';

            const allSpecifics = document.querySelectorAll('.class-specific');

            allSpecifics.forEach(el => {
                let isMatch = false;
                el.classList.forEach(c => {
                    if(c.startsWith('class-') && c !== 'class-specific') {
                        const className = c.replace('class-', '');
                        if (clsNormal.includes(className)) {
                            isMatch = true;
                            // Set the emoji in the main class input if matched
                            if (classEmojiMap[className]) {
                                inputBadge.textContent = classEmojiMap[className];
                            }
                        }
                    }
                });

                if (isMatch) {
                    el.classList.remove('hidden-class-feature');
                } else {
                    el.classList.add('hidden-class-feature');
                }
            });
        };

        // --- GHOST INPUT LOGIC ---
        function applyHighlights(text) {
            if (!AI_COMMENTS || Object.keys(AI_COMMENTS).length === 0 || !tipsEnabled) return text;
            const keys = Object.keys(AI_COMMENTS).sort((a, b) => b.length - a.length);
            const patternStr = keys.map(k => k.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&').replaceAll(/'s(\b)/g, "'?s").replaceAll(/s(\b)/g, "s?")).join('|');
            const pattern = new RegExp(`\\b(${patternStr})\\b`, 'gi');
            let html = text.replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
            return html.replace(pattern, (matched) => `<span class="highlight" data-tip="${matched.toLowerCase()}">${matched}</span>`);
        }

        window.attachGhost = function(input) {
            if(input.classList.contains('ghost-input')) return; // Already attached

            // 1. Setup Wrapper & Mirror
            const wrapper = document.createElement('div');
            wrapper.className = 'ghost-container';
            input.parentNode.insertBefore(wrapper, input);
            wrapper.appendChild(input);
            input.classList.add('ghost-input');

            const mirror = document.createElement('div');
            mirror.className = 'ghost-mirror';
            wrapper.insertBefore(mirror, input);

            // 2. Sync Styles
            const style = window.getComputedStyle(input);
            mirror.style.fontFamily = style.fontFamily;
            mirror.style.fontSize = style.fontSize;
            mirror.style.lineHeight = style.lineHeight;
            mirror.style.padding = style.padding;
            mirror.style.border = style.border;
            mirror.style.letterSpacing = style.letterSpacing;

            // Handle different input types
            if (input.tagName === 'INPUT') {
                mirror.style.whiteSpace = 'pre';
                mirror.style.overflow = 'hidden';
            } else {
                mirror.style.whiteSpace = 'pre-wrap';
            }

            // 3. Logic Functions
            const updateGhost = () => {
                const text = input.value;
                const cursorIdx = input.selectionStart;

                let suggestion = "";
                const wordsBefore = text.slice(0, cursorIdx).split(/[\s\n]+/);
                const lastWord = wordsBefore[wordsBefore.length - 1];
                if (lastWord && lastWord.length >= 3) {
                    const match = Object.keys(AI_COMMENTS).find(k => k.toLowerCase().startsWith(lastWord.toLowerCase()));
                    if (match) suggestion = match.slice(lastWord.length);
                }

                mirror.innerHTML = applyHighlights(text.slice(0, cursorIdx)) + `<span class="suggestion">${suggestion}</span>` + applyHighlights(text.slice(cursorIdx));
                mirror.scrollTop = input.scrollTop;
                mirror.scrollLeft = input.scrollLeft;
            };

            // 4. Listeners
            input.addEventListener('input', updateGhost);
            input.addEventListener('scroll', () => { mirror.scrollTop = input.scrollTop; mirror.scrollLeft = input.scrollLeft; });
            input.addEventListener('click', updateGhost);
            input.addEventListener('keyup', (e) => {
                if (['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','End','Home'].includes(e.key)) updateGhost();
            });
            input.addEventListener('mouseleave', () => {
                if (lastTipKey !== "") {
                    lastTipKey = "";
                    hideTip();
                }
            });

            // Tab Completion
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    const cursorIdx = input.selectionStart;
                    const wordsBefore = input.value.slice(0, cursorIdx).split(/[\s\n]+/);
                    const lastWord = wordsBefore[wordsBefore.length - 1];
                    if (lastWord && lastWord.length >= 3) {
                        const match = Object.keys(AI_COMMENTS).find(k => k.toLowerCase().startsWith(lastWord.toLowerCase()));
                        if (match) {
                            e.preventDefault();
                            const start = cursorIdx - lastWord.length;
                            const newValue = input.value.slice(0, start) + match + input.value.slice(cursorIdx);
                            input.value = newValue;
                            input.selectionStart = input.selectionEnd = start + match.length;
                            updateGhost();
                            handleInput({target: input}); // Trigger autosave
                        }
                    }
                }
            });

            // Peek Tooltip
            let lastTipKey = "";
            input.addEventListener('mousemove', (e) => {
                input.style.pointerEvents = 'none';
                const under = document.elementFromPoint(e.clientX, e.clientY);
                input.style.pointerEvents = 'auto';

                if (under && under.classList.contains('highlight')) {
                    const tipKey = under.dataset.tip;
                    if (tipKey !== lastTipKey) {
                        const match = getMatch(tipKey);
                        if (match) {
                            lastTipKey = tipKey;
                            currentTarget = under;
                            showTip(e, match.text, match.title);
                        }
                    } else { moveTip(e); }
                } else {
                    if (lastTipKey !== "") { lastTipKey = ""; hideTip(); }
                }
            });
        };

        function initGhosts() {
            // Static textareas
            const ids = ['prof-weapons-text', 'prof-tools-text', 'class-features', 'background-features', 'species-traits', 'feats', 'appearance', 'backstory', 'equipment', 'languages'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(el) attachGhost(el);
            });
        }

        // --- SHARED UTILS ---
        async function loadSharedCharacter(sharedId) {
            isLoading = true;
            document.getElementById('status').innerText = "Loading Shared...";

            try {
                let targetData = null;
                let finalId = sharedId;

                // 1. Try direct lookup (Full ID)
                const docRef = doc(db, "characters", sharedId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    targetData = docSnap.data();
                } else if (sharedId.length === 8) {
                    // 2. Prefix search for Short ID
                    const q = query(
                        collection(db, "characters"),
                        where("__name__", ">=", sharedId),
                        where("__name__", "<", sharedId + '\uf8ff'),
                        limit(1)
                    );
                    const querySnap = await getDocs(q);
                    if (!querySnap.empty) {
                        targetData = querySnap.docs[0].data();
                        finalId = querySnap.docs[0].id;
                    }
                }

                if (targetData) {
                    currentCharacterId = finalId;
                    localStorage.setItem('dnd_char_id', currentCharacterId);
                    populateData(targetData.sheetData);
                    if(targetData.sheetData['portrait-url']) updatePortraitFromURL(targetData.sheetData['portrait-url']);

                    if (currentUser && targetData.ownerId === currentUser.uid) {
                        isCloudOwner = true;
                        setupRealtimeListener();
                        document.getElementById('status').innerText = "Online (Owner)";
                    } else {
                        // If not owner, just stop here. No listener = No "Access Control" error.
                        isCloudOwner = false;
                        document.getElementById('status').innerText = "Read Only Mode";
                    }
                } else {
                    alert("Character not found.");
                }
            } catch (e) {
                console.error("Shared load failed:", e);
            } finally {
                isLoading = false;
                updateModifiers();
            }
        }

        async function updateSnapshotSelect() {
            if (!currentUser) return;
            const snapshotsCol = collection(db, "characters", currentCharacterId, "snapshots");
            try {
                const snapDocs = await getDocs(snapshotsCol);
                const select = document.getElementById('versionSelect');
                select.innerHTML = '<option value="">Load Version...</option>';
                snapDocs.forEach(d => {
                    const data = d.data(); const opt = document.createElement('option'); opt.value = d.id;
                    opt.text = `${data.name} (${new Date(data.createdAt).toLocaleDateString()})`; select.appendChild(opt);
                });
            } catch(e) { console.error("Snapshot load error:", e); }
        }

        function collectData() {
            const data = { charName: document.getElementById('charName').value };
            document.querySelectorAll('input[id]:not([type="file"]), textarea[id], select[id]').forEach(el => {
                data[el.id] = (el.type === 'checkbox') ? el.checked : el.value;
            });
            data['weapons'] = [];
            document.querySelectorAll('#weapons-body tr').forEach(tr => {
                const i = tr.querySelectorAll('input');
                data['weapons'].push({name: i[0].value, atk: i[1].value, dmg: i[2].value, notes: i[3].value});
            });
            data.wild_shapes = [];
            document.querySelectorAll('#wild-shape-body tr').forEach(tr => {
                const i = tr.querySelectorAll('input');
                data.wild_shapes.push({name: i[0].value, cr: i[1].value, hp: i[2].value, ac: i[3].value, spd: i[4].value, notes: i[5].value});
            });

            data.invocations = [];
            document.querySelectorAll('#invocations-body tr').forEach(tr => {
                const i = tr.querySelectorAll('input');
                data.invocations.push({name: i[0].value, desc: i[1].value});
            });
            data.magic_items = Array.from(document.querySelectorAll('#magic-items-body tr')).map(tr => {
                const inputs = tr.querySelectorAll('input');
                return {
                    created: inputs[0].checked,    // First checkbox
                    name: inputs[1].value,         // Text input
                    attunement: inputs[2].checked, // Second checkbox
                    notes: inputs[3].value         // Text input
                };
            });
            data['equipment_table'] = [];
            document.querySelectorAll('#equipment-body tr').forEach(tr => {
                const inputs = tr.querySelectorAll('input');
                data['equipment_table'].push({
                    name: inputs[0].value,
                    qty: inputs[1].value,
                    lbs: inputs[2].value,
                    notes: inputs[3].value
                });
            });
            data['people_table'] = [];
            document.querySelectorAll('#people-body tr').forEach(tr => {
                const inputs = tr.querySelectorAll('input');
                const people_notes = tr.querySelector('textarea').value;
                data['people_table'].push({
                    name: inputs[0].value,
                    desc: inputs[1].value,
                    notes: people_notes
                });
            });
            data['spells'] = [];
            document.querySelectorAll('#spells-body tr').forEach(tr => {
                const i = tr.querySelectorAll('input');
                data['spells'].push({lvl: i[0].value, name: i[1].value, conc: i[2].checked, rit: i[3].checked, mat: i[4].checked});
            });
            data['spellSlots'] = {};
            document.querySelectorAll('.spell-slots-grid input[type="checkbox"]').forEach(cb => { data['spellSlots'][cb.id] = cb.checked; });
            return data;
        }

        function populateData(data) {
            if(!data) return;
            isAppReady = false;

            try {
                for (const [key, value] of Object.entries(data)) {
                    if(['spellSlots', 'weapons', 'spells', 'equipment', 'magic_items', 'portrait-upload'].includes(key)) continue;
                    const el = document.getElementById(key);
                    if (el) { if(el.type === 'checkbox') el.checked = value; else el.value = value; }
                }
                if (data.equipment_table && Array.isArray(data.equipment_table)) {
                    const tbody = document.getElementById('equipment-body');
                    tbody.innerHTML = ''; // Clear existing
                    data.equipment_table.forEach(item => {
                        window.addEquipmentRow(item); // Pass item data to the row creator
                    });
                } else if (typeof data.equipment === 'string' && data.equipment.trim() !== "") {
                    // Migration: If they had old text equipment, put it in the first row of the table
                    window.addEquipmentRow({name: data.equipment, qty: 1, lbs: 0, notes: "Imported from text"});
                }
                if(data.people_table) {
                    document.getElementById('people-body').innerHTML = '';
                    for(let i=0; i<Math.max(5, data.people_table.length); i++) window.addPeopleRow();
                    const rows = document.querySelectorAll('#people-body tr');
                    data.people_table.forEach((r, i) => { if(rows[i]) {
                        let inputs = rows[i].querySelectorAll('input');
                        let people_notes = rows[i].querySelector('textarea');
                        inputs[0].value=r.name;
                        inputs[1].value=r.desc;
                        people_notes.value=r.notes;
                    }});
                }
                if(data.weapons) {
                    document.getElementById('weapons-body').innerHTML = '';
                    for(let i=0; i<Math.max(5, data.weapons.length); i++) window.addWeaponRow();
                    const rows = document.querySelectorAll('#weapons-body tr');
                    data.weapons.forEach((r, i) => { if(rows[i]) { let inputs = rows[i].querySelectorAll('input'); inputs[0].value=r.name; inputs[1].value=r.atk; inputs[2].value=r.dmg; inputs[3].value=r.notes; }});
                }
                if(data.wild_shapes) {
                    document.getElementById('wild-shape-body').innerHTML = '';
                    data.wild_shapes.forEach(r => window.addWildShapeRow(r));
                }
                if(data.invocations) {
                    document.getElementById('invocations-body').innerHTML = '';
                    data.invocations.forEach(r => window.addInvocationRow(r));
                }
                if (data.magic_items) {
                    document.getElementById('magic-items-body').innerHTML = '';
                    data.magic_items.forEach(item => window.addMagicItemRow(item));
                }
                if(data.spells) {
                    document.getElementById('spells-body').innerHTML = '';
                    for(let i=0; i<Math.max(15, data.spells.length); i++) window.addSpellRow();
                    const rows = document.querySelectorAll('#spells-body tr');
                    data.spells.forEach((r, i) => { if(rows[i]) { let inputs = rows[i].querySelectorAll('input'); inputs[0].value=r.lvl; inputs[1].value=r.name; inputs[2].checked=r.conc; inputs[3].checked=r.rit; inputs[4].checked=r.mat; }});
                }
                if(data.spellSlots) {
                    for (const [slotId, checked] of Object.entries(data.spellSlots)) {
                        const el = document.getElementById(slotId);
                        if(el) el.checked = checked;
                    }
                }
                if (data.portraitUrl) {
                    updatePortraitFromURL(data.portraitUrl);
                }
                // Trigger an input event on all ghost inputs to update mirrors
                document.querySelectorAll('.ghost-input').forEach(el => el.dispatchEvent(new Event('input')));
                updateModifiers(); updatePageTitle(); updateWeight(); window.updateClassFeatures();

                isAppReady = false;
            } catch (err) {
                console.error("CRITICAL ERROR LOADING DATA:", err);
                alert("There was an error loading your character data. Automatic saving has been disabled to prevent data loss. Please refresh the page or check the console.");
                isAppReady = false; // Prevent saving
            }
        }

        function updateModifiers() {
            const stats = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
            const profBonus = parseInt(document.getElementById('prof-bonus').value) || 0;

            const fmt = (val) => (val >= 0 ? "+" : "") + val;

            stats.forEach(stat => {
                const modEl = document.getElementById(`${stat}-mod`);
                const scoreEl = document.getElementById(`${stat}-score`);
                if (scoreEl && modEl) {
                   const score = parseInt(scoreEl.value);
                   if (isNaN(score)) {
                       modEl.value = "";
                   } else {
                       const mod = Math.floor((score - 10) / 2);
                       modEl.value = fmt(mod);

                       const saveProf = document.getElementById(`save-prof-${stat}`).checked;
                       const saveVal = document.getElementById(`save-val-${stat}`);
                       const totalSave = mod + (saveProf ? profBonus : 0);
                       saveVal.value = fmt(totalSave);

                       document.querySelectorAll(`[id^="val-${stat}-"]`).forEach(skillInput => {
                           const skillId = skillInput.id.replace('val-', 'prof-');
                           const isProficient = document.getElementById(skillId).checked;
                           const totalSkill = mod + (isProficient ? profBonus : 0);
                           skillInput.value = fmt(totalSkill);
                       });
                    }
                }
            });

            const selectedStat = document.getElementById('spell-ability').value;
            if (selectedStat) {
                const scoreEl = document.getElementById(`${selectedStat}-score`);
                const mod = Math.floor((parseInt(scoreEl.value || 10) - 10) / 2);
                const other_mod = parseInt(document.getElementById('other-mod').value || "0");
                document.getElementById('spell-mod').value = fmt(mod);
                document.getElementById('spell-save-dc').value = 8 + profBonus + mod;
                document.getElementById('spell-atk').value = fmt(profBonus + mod + other_mod);
            }

            // Task 4: Auto-calculate Passive Perception
            // Logic: 10 + Wis Mod + (ProfBonus if proficient in Perception)
            const wisScore = parseInt(document.getElementById('wisdom-score').value) || 10;
            const wisMod = Math.floor((wisScore - 10) / 2);
            const isPercProf = document.getElementById('prof-wisdom-perception')?.checked || false;

            const passPercEl = document.getElementById('pass-perc');
            if (passPercEl) {
                passPercEl.value = 10 + wisMod + (isPercProf ? profBonus : 0);
            }
        }

        function handleInput(e) {
            const targetId = e?.target?.id || "";
            const targetType = e?.target?.type || "";

            if (targetId === 'class') {
                window.updateClassFeatures();
            }

            if (targetId.endsWith('-score') || targetId === 'prof-bonus' || targetType === 'checkbox' || targetId === 'spell-ability') {
                updateModifiers();
            }

            const charName = document.getElementById('char-name')?.value.trim();
            if (!isLoading && isAppReady && charName !== "") {
                // Also, don't save if the character does not have a name.
                lastLocalChangeTimestamp = Date.now();
                debounce(() => window.saveVersion(false), 2000)();
            }
        }

        function debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }
        function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (c=='x'?Math.random()*16|0:(Math.random()*16|0)&0x3|0x8).toString(16)); }
        function updatePageTitle() { const name = document.getElementById('charName').value; if(name) document.title = name + " - 5e"; }

        window.shareSheet = async function() {
            if (!currentUser) { alert("Login required."); return; }
            await window.saveVersion(false);
            const shareUrl = `${window.location.origin}${window.location.pathname}?charId=${currentCharacterId.substring(0, 8)}`;
            try { await navigator.clipboard.writeText(shareUrl); alert("Link copied!"); } catch (err) { prompt("Copy:", shareUrl); }
        }

        window.addWeaponRow = () => {
            const tbody = document.getElementById('weapons-body');
            const tr = document.createElement('tr');
            tr.draggable = true;
            tr.addEventListener('dragstart', handleDragStart);
            tr.addEventListener('dragover', handleDragOver);
            tr.addEventListener('drop', handleDrop);
            tr.addEventListener('dragend', handleDragEnd);

            tr.innerHTML = `
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td><input type="text"></td>
                <td class="action-cell"><button class="drag-handle" title="Drag to reorder">‚ò∞</button><button class="remove-btn" tabindex="-1">-</button></td>`;

            tbody.appendChild(tr);
            const inputs = tr.querySelectorAll('input');
            inputs.forEach(i => i.addEventListener('input', handleInput));

            // Logic for removal
            tr.querySelector('.remove-btn').onclick = () => {
                if (confirm("Remove this weapon?")) {
                    tr.remove();
                    handleInput({ target: document.body }); // Trigger autosave
                }
            };

            attachGhost(inputs[0]); // Name
            attachGhost(inputs[3]); // Notes
        };

        window.addWildShapeRow = (item = null) => {
            const tbody = document.getElementById('wild-shape-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" value="${item ? item.name : ''}"></td>
                <td><input type="text" value="${item ? item.cr : ''}" style="text-align:center"></td>
                <td><input type="text" value="${item ? item.hp : ''}" style="text-align:center"></td>
                <td><input type="text" value="${item ? item.ac : ''}" style="text-align:center"></td>
                <td><input type="text" value="${item ? item.spd : ''}" style="text-align:center"></td>
                <td><input type="text" value="${item ? item.notes : ''}"></td>
                <td class="action-cell"><button onclick="this.parentElement.parentElement.remove(); handleInput();" class="remove-btn">-</button></td>`;
            tbody.appendChild(tr);
            tr.querySelectorAll('input').forEach(i => i.addEventListener('input', handleInput));
        };

        window.addInvocationRow = (item = null) => {
            const tbody = document.getElementById('invocations-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" value="${item ? item.name : ''}"></td>
                <td><input type="text" value="${item ? item.desc : ''}"></td>
                <td class="action-cell"><button onclick="this.parentElement.parentElement.remove(); handleInput();" class="remove-btn">-</button></td>`;
            tbody.appendChild(tr);
            tr.querySelectorAll('input').forEach(i => i.addEventListener('input', handleInput));
        };

        window.addSpellRow = () => {
            const tbody = document.getElementById('spells-body');
            const tr = document.createElement('tr');
            tr.draggable = true;
            tr.addEventListener('dragstart', handleDragStart);
            tr.addEventListener('dragover', handleDragOver);
            tr.addEventListener('drop', handleDrop);
            tr.addEventListener('dragend', handleDragEnd);
            tr.innerHTML = `
                <td><input type="text" style="width:25px; text-align:center;"></td>
                <td><input type="text"></td>
                <td style="white-space: nowrap; text-align: center;">
                    <input type="checkbox" class="diamond-check">
                    <input type="checkbox" class="diamond-check">
                    <input type="checkbox" class="diamond-check">
                    <input type="checkbox" class="diamond-check">
                    <input type="checkbox" class="diamond-check">
                </td>
                <td class="action-cell"><button class="drag-handle" title="Drag to reorder">‚ò∞</button><button class="remove-btn" tabindex="-1">-</button></td>`;

            tbody.appendChild(tr);
            const inputs = tr.querySelectorAll('input');
            inputs.forEach(i => i.addEventListener('input', handleInput));

            // Logic for removal
            tr.querySelector('.remove-btn').onclick = () => {
                if (confirm("Remove this spell?")) {
                    tr.remove();
                    handleInput({ target: document.body }); // Trigger autosave
                }
            };

            attachGhost(inputs[1]); // Spell Name
        };

        window.addMagicItemRow = (item = null) => {
            const tbody = document.getElementById('magic-items-body');
            const tr = document.createElement('tr');
            tr.draggable = true;
            tr.addEventListener('dragstart', handleDragStart);
            tr.addEventListener('dragover', handleDragOver);
            tr.addEventListener('drop', handleDrop);
            tr.addEventListener('dragend', handleDragEnd);
            tr.innerHTML = `
                <td style="text-align: center;">
                    <input type="checkbox" ${item?.created ? 'checked' : ''} style="width: auto;">
                </td>
                <td><input type="text" value="${item ? item.name : ''}" placeholder="Item name..."></td>
                <td style="text-align: center;">
                    <input type="checkbox" ${item?.attunement ? 'checked' : ''} style="width: auto;">
                </td>
                <td><input type="text" value="${item ? item.notes : ''}" placeholder="Details..."></td>
                <td class="action-cell"><button class="drag-handle" title="Drag to reorder">‚ò∞</button><button onclick="this.parentElement.parentElement.remove(); handleInput();" class="remove-btn">-</button></td>
            `;

            tbody.appendChild(tr);
            // Ensure both text inputs and checkboxes trigger a save
            tr.querySelectorAll('input').forEach(el => el.addEventListener('input', () => handleInput()));
        };

        window.addEquipmentRow = (item = null) => {
            const tbody = document.getElementById('equipment-body');
            const tr = document.createElement('tr');
            tr.draggable = true;
            tr.addEventListener('dragstart', handleDragStart);
            tr.addEventListener('dragover', handleDragOver);
            tr.addEventListener('drop', handleDrop);
            tr.addEventListener('dragend', handleDragEnd);
            tr.innerHTML = `
                <td><input type="text" value="${item ? item.name : ''}"></td>
                <td><input type="number" value="${item ? item.qty : 1}" style="text-align:center;"></td>
                <td><input type="number" value="${item ? item.lbs : 0}" style="text-align:center;"></td>
                <td><input type="text" value="${item ? item.notes : ''}"></td>
                <td class="action-cell"><button class="drag-handle" title="Drag to reorder">‚ò∞</button><button onclick="this.parentElement.parentElement.remove(); updateWeight();" class="remove-btn">-</button></td>
            `;
            tbody.appendChild(tr);
            tr.querySelectorAll('input').forEach(i => i.addEventListener('input', updateWeight));
            updateWeight();
        };

        window.addPeopleRow = (item = null) => {
            const tbody = document.getElementById('people-body');
            const tr = document.createElement('tr');
            tr.draggable = true;
            tr.addEventListener('dragstart', handleDragStart);
            tr.addEventListener('dragover', handleDragOver);
            tr.addEventListener('drop', handleDrop);
            tr.addEventListener('dragend', handleDragEnd);
            tr.innerHTML = `
                <td><input type="text" value="${item ? item.name : ''}"></td>
                <td><input type="text" value="${item ? item.desc : ''}"></td>
                <td><textarea value="${item ? item.notes : ''}" style="height:4lh;"></textarea></td>
                <td class="action-cell"><button class="drag-handle" title="Drag to reorder">‚ò∞</button><button onclick="this.parentElement.parentElement.remove(); updateWeight();" class="remove-btn">-</button></td>
            `;
            tbody.appendChild(tr);
            tr.querySelectorAll('input').forEach(i => i.addEventListener('input', updateWeight));
            updateWeight();
        };

        // --- Drag and Drop Logic ---
        let dragSrcEl = null;

        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();

            if (dragSrcEl !== this && dragSrcEl.parentNode === this.parentNode) {
                // Determine if dragging up or down
                const allRows = Array.from(this.parentNode.children);
                const dragIdx = allRows.indexOf(dragSrcEl);
                const dropIdx = allRows.indexOf(this);

                if (dragIdx < dropIdx) {
                    this.parentNode.insertBefore(dragSrcEl, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(dragSrcEl, this);
                }
                handleInput(); // Trigger your existing save logic
            }
            return false;
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
        }

        function updateWeight() {
            let total = 0;
            // Sum rows
            document.querySelectorAll('#equipment-body tr').forEach(tr => {
                const inputs = tr.querySelectorAll('input');
                const qty = parseFloat(inputs[1].value) || 0;
                const lbs = parseFloat(inputs[2].value) || 0;
                total += (qty * lbs);
            });
            // Sum coins (50 coins = 1 lb)
            const coinIds = ['cp','sp','ep','gp','pp'];
            let coinCount = 0;
            coinIds.forEach(id => {
                coinCount += (parseInt(document.getElementById(id).value) || 0);
            });
            total += (coinCount / 50);

            document.getElementById('total-weight').innerText = total.toFixed(1);
            handleInput({ target: document.body }); // Trigger auto-save
        }

        window.resetSheet = function() {
            if(confirm("Create new character? Unsaved changes will be lost.")) {
                currentCharacterId = generateUUID(); localStorage.setItem('dnd_char_id', currentCharacterId);
                window.location.href = window.location.pathname;
            }
        };

        // --- TAB SCROLL AND SWITCH ---
        const tabsWrapper = document.getElementById('tabs-wrapper');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabIds = ['main-page', 'spells-page', 'items-page', 'equip-page'];

        window.switchTab = function(tabId) {  // Click-to-tab logic
            const target = document.getElementById(tabId);
            target.scrollIntoView({ behavior: 'smooth' });
        }

        const observerOptions = {
            root: null,
            rootMargin: '-40% 0px -60% 0px', // Detects when section is in the middle-ish area
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute('id');

                    // Update Buttons
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        // Check if the button's onclick contains the ID
                        if (btn.getAttribute('onclick').includes(id)) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                }
            });
        }, observerOptions);

        // Start observing all tab sections
        document.querySelectorAll('.tab-content').forEach(section => {
            observer.observe(section);
        });

        function generateStaticContent() {
            const abilityData = { "Strength": ["Athletics"], "Dexterity": ["Acrobatics", "Sleight of Hand", "Stealth"], "Constitution": [], "Intelligence": ["Arcana", "History", "Investigation", "Nature", "Religion"], "Wisdom": ["Animal Handling", "Insight", "Medicine", "Perception", "Survival"], "Charisma": ["Deception", "Intimidation", "Performance", "Persuasion"] };
            const abilitiesContainer = document.getElementById('ability-scores-container');
            if(abilitiesContainer) {
                let html = '';
                for (const [stat, skills] of Object.entries(abilityData)) {
                    const lowStat = stat.toLowerCase();
                    let skillsHtml = '';
                    skills.forEach(skill => {
                        const skillId = skill.replace(/\s+/g, '-').toLowerCase();
                        skillsHtml += `<div class="skill-row"><input type="text" class="save-val-input" id="val-${lowStat}-${skillId}" placeholder="+0" readonly><input type="checkbox" class="prof-bubble" id="prof-${lowStat}-${skillId}"><span>${skill}</span></div>`;
                    });
                    html += `
                    <div class="ability-box">
                    <span class="box-title" data-tip="${stat}" tabindex="0">${stat}</span>
                    <div class="ability-visual-container">
                        <input type="text" id="${lowStat}-mod" class="ability-mod" placeholder="+0" readonly tabindex="-1">
                        <input type="number" id="${lowStat}-score" class="ability-score" placeholder="10">
                    </div>
                    <div class="skills-list">
                        <div class="skill-row" style="font-weight: bold; border-bottom: 2px solid #ccc;">
                            <input type="text" class="save-val-input" id="save-val-${lowStat}" placeholder="+0" readonly>
                            <input type="checkbox" class="prof-bubble" id="save-prof-${lowStat}">
                            <span>Saving Throw</span>
                        </div>
                        ${skillsHtml}
                    </div>
                </div>`;
                }
                abilitiesContainer.innerHTML = html;
            }
            const slotContainer = document.getElementById('spell-slots-container');
            if(slotContainer) {
                const slotCounts = [0, 4, 3, 3, 3, 3, 2, 2, 1, 1];
                let html = '';
                for(let i=1; i<=9; i++) {
                    html += `<div>${i}${i===1?'st':i===2?'nd':i===3?'rd':'th'} `;
                    for(let j=0; j<slotCounts[i]; j++) html += `<input type="checkbox" class="diamond-check" id="slot-${i}-${j}">`;
                    html += `</div>`;
                }
                slotContainer.innerHTML = html;
            }
        }

        window.toggleManagementMenu = function(event) {
            event.stopPropagation(); // Prevents the click from immediately reaching the window listener
            const menu = document.getElementById('management-menu');
            menu.classList.toggle('show');
        };

        // Close the menu if the user clicks outside of it
        window.addEventListener('click', (event) => {
            const menu = document.getElementById('management-menu');
            if (menu && menu.classList.contains('show')) {
                if (!event.target.closest('.dropdown')) {
                    menu.classList.remove('show');
                }
            }
        });

        window.shortRest = function() {
            const hpMax = parseInt(document.getElementById('hp-max').value) || 0;
            const hpCurr = parseInt(document.getElementById('hp-curr').value) || 0;
            if (hpCurr >= hpMax) return;
            const roll = prompt("Short Rest: Enter total HP regained (Hit Dice rolls + Con mod):", "0");
            if (roll === null) return;
            const regained = parseInt(roll) || 0;
            document.getElementById('hp-curr').value = Math.min(hpMax, hpCurr + regained);
            handleInput({ target: document.getElementById('hp-curr') });
        };

        window.longRest = function() {
            if (!confirm("Confirm Long Rest? This will reset HP, Spell Slots, and remove Temp HP.")) return;
            document.getElementById('hp-curr').value = document.getElementById('hp-max').value;
            document.getElementById('hp-temp').value = "";
            for (let i = 1; i <= 3; i++) { document.getElementById(`ds-s-${i}`).checked = false; document.getElementById(`ds-f-${i}`).checked = false; }
            document.querySelectorAll('.spell-slots-grid input[type="checkbox"]').forEach(cb => { cb.checked = false; });
            handleInput({ target: document.getElementById('hp-curr') });
        };

        window.toggleTips = () => {
             tipsEnabled = !tipsEnabled;
             const btn = document.getElementById('toggle-tips');
             document.body.classList.toggle('tips-enabled', tipsEnabled);
             btn.innerText = `Tips: ${tipsEnabled ? 'ON' : 'OFF'}`;
             btn.style.background = tipsEnabled ? '#4a5568' : '#222';
             // Re-trigger ghosts to update highlights immediately
             document.querySelectorAll('.ghost-input').forEach(el => el.dispatchEvent(new Event('input')));
         };

        const tooltipEl = document.getElementById('ai-tooltip');
        let currentTarget = null;
        function showTip(e, text, title) {
            if (!tipsEnabled || !text || text.length === 0) return;
            const quote = text[Math.floor(Math.random() * text.length)];
            tooltipEl.innerHTML = `<strong>${title}</strong>${quote}`;
            tooltipEl.style.opacity = '1';
            moveTip(e);
        }

        function moveTip(e) {
            if (!e.clientX) return;
            const x = e.clientX + 15; const y = e.clientY + 15;
            const rect = tooltipEl.getBoundingClientRect();
            const safeX = (x + rect.width > window.innerWidth) ? x - rect.width - 20 : x;
            const safeY = (y + rect.height > window.innerHeight) ? y - rect.height - 20 : y;
            tooltipEl.style.left = `${safeX}px`; tooltipEl.style.top = `${safeY}px`;
        }

        function hideTip() { tooltipEl.style.opacity = '0'; currentTarget = null; }
        function getMatch(str) {
            if (!str) return null;
            const normalize = (s) => s.trim().toLowerCase().replaceAll(/'s(\b)/g, '').replaceAll(/s(\b)/g, '')
            const search = normalize(str);
            const key = Object.keys(AI_COMMENTS).find(k => normalize(k) === search);
            return key ? { title: key, text: AI_COMMENTS[key] } : null;
        }

        async function setupTooltips() {
            try {
                const response = await fetch('./ai_comments.json');
                if (!response.ok) throw new Error('Failed to load AI comments');
                AI_COMMENTS = await response.json();
            } catch (err) { console.error("Tooltip data error:", err); return; }

            document.body.addEventListener('focusin', (e) => {
                 const target = e.target.closest('[data-tip]');
                 if (target && AI_COMMENTS[target.dataset.tip]) {
                    const rect = target.getBoundingClientRect();
                    showTip({ clientX: rect.right, clientY: rect.bottom }, AI_COMMENTS[target.dataset.tip], target.dataset.tip);
                 }
            });
            document.body.addEventListener('focusout', hideTip);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            generateStaticContent();
            initGhosts(); // Initialize ghosts on static inputs
            await setupTooltips();

            document.body.addEventListener('mouseover', (e) => {
                const target = e.target.closest('[data-tip]');
                if (target) {
                    const match = getMatch(target.dataset.tip);
                    if (match) { currentTarget = target; showTip(e, match.text, match.title); }
                }
            });
            document.body.addEventListener('mousemove', (e) => { if (currentTarget) moveTip(e); });
            document.body.addEventListener('mouseout', (e) => { if (e.target.closest('[data-tip]')) hideTip(); });

            const allInputs = document.querySelectorAll('input, textarea, select');
            allInputs.forEach(input => { input.addEventListener('input', handleInput); });

            document.querySelectorAll('.coin-slot input').forEach(coinInput => {
                coinInput.addEventListener('input', updateWeight);
            });

            // Portrait
            const portraitInput = document.getElementById('portrait-url');
            if (portraitInput) {
                portraitInput.addEventListener('input', (e) => {
                    updatePortraitFromURL(e.target.value);
                    handleInput(e);
                });

                // Optional: Hide the input when it loses focus
                portraitInput.addEventListener('blur', () => {
                    if (portraitInput.value.trim() !== "") {
                        document.getElementById('portrait-container').classList.remove('editing');
                    }
                });
            }

            const urlParams = new URLSearchParams(window.location.search);
            const sharedId = urlParams.get('charId');
            if (sharedId) await loadSharedCharacter(sharedId);
            if (!sharedId) isAppReady = true;
        });
    </script>
</body>
</html>
