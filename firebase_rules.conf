rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    match /characters/{charId} {
      // 1. World Readable
      allow read: if true;

      // 2. Owner Editable
      // - Create: Must be logged in. We also validate that the data claims ownership for the current user.
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      
      // - Update: User must match the existing ownerId. 
      // - Logic: Ensure the user cannot transfer ownership (change the ownerId field) during an update.
      allow update: if request.auth != null 
                    && request.auth.uid == resource.data.ownerId
                    && request.resource.data.ownerId == resource.data.ownerId;
      
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;

      // 3. Versioned Snapshots
      // Nesting snapshots under the character ensures logical grouping.
      match /snapshots/{snapshotId} {
        allow read: if true;
        // Write: Only allowed if the PARENT character document is owned by this user.
        allow write: if request.auth != null 
                     && get(/databases/$(database)/documents/characters/$(charId)).data.ownerId == request.auth.uid;
      }
    }

    // Stores "GuildID-UserID" -> Character_ID mappings
    // (Allows different characters per server)
    match /discord_mappings/{mappingId} {
      allow read, write: if true;
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    match /portraits/{userId} {
      // Allow anyone to see the image (needed for sharing)
      allow read: if true;
      // Only allow the owner to upload/replace their own image
      // Note: We check if the filename matches the character ID
      allow write: if request.auth != null; 
    }

    // Stores GuildID -> { members: { "Key": "CharID" } }
    // (Party aliases are now shared per server)
    match /dm_parties/{partyId} {
      allow read, write: if true;
    }
  }
}