import { InteractionType, InteractionResponseType, verifyKey } from 'discord-interactions';

export default async function handler(req, res) {
    // 1. Verify the request (Discord security requirement)
    const signature = req.headers['x-signature-ed25519'];
    const timestamp = req.headers['x-signature-timestamp'];
    const rawBody = JSON.stringify(req.body);

    const isValidRequest = verifyKey(
        rawBody,
        signature,
        timestamp,
        process.env.DISCORD_PUBLIC_KEY // Set this in Vercel Dashboard
    );

    if (!isValidRequest) {
        return res.status(401).send('Bad request signature');
    }

    // 2. Handle the Interaction
    const interaction = req.body;

    if (interaction.type === InteractionType.PING) {
        return res.send({ type: InteractionResponseType.PONG });
    }

    if (interaction.type === InteractionType.APPLICATION_COMMAND) {
        const { name } = interaction.data;

        if (name === 'roll') {
            const roll = Math.floor(Math.random() * 20) + 1;
            return res.send({
                type: InteractionResponseType.CHANNEL_MESSAGE_WITH_SOURCE,
                data: { content: `ðŸŽ² You rolled a **${roll}**!` },
            });
        }
    }

    return res.status(400).send('Unknown interaction');
}
